<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise da Operação Barricada Zero</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <!-- SheetJS CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #1a5fb4;
            --secondary-color: #26a269;
            --accent-color: #e5a50a;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', system-ui, sans-serif;
            padding-top: 20px;
            padding-bottom: 40px;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--primary-color), #0d47a1);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }
        
        .card-custom {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-custom:hover {
            transform: translateY(-5px);
        }
        
        .card-header-custom {
            background-color: var(--primary-color);
            color: white;
            border-bottom: none;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .stat-card {
            background: white;
            border-left: 5px solid var(--primary-color);
            padding: 15px;
            height: 100%;
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-card .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .priority-high {
            border-left-color: #e01b24 !important;
        }
        
        .priority-medium {
            border-left-color: var(--accent-color) !important;
        }
        
        .priority-low {
            border-left-color: #26a269 !important;
        }
        
        .table-custom {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table-custom thead th {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 15px;
        }
        
        .table-custom tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .btn-custom {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            background-color: #0d47a1;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .insight-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 5px solid var(--accent-color);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .action-plan-day {
            background-color: #f0f7ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .file-input-area {
            border: 2px dashed #ced4da;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .file-input-area:hover {
            border-color: var(--primary-color);
            background-color: #e9f2ff;
        }
        
        .pdf-section {
            page-break-inside: avoid;
            margin-bottom: 20px;
        }
        
        #loadingPdf {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
        
        .planning-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .planning-table th {
            background-color: #1a5fb4;
            color: white;
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .planning-table td {
            padding: 8px;
            border: 1px solid #ddd;
            vertical-align: top;
        }
        
        .planning-table .week-cell {
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: center;
        }
        
        .planning-table .day-cell {
            background-color: #f0f7ff;
            position: relative;
        }
        
        .validated-bpm {
            color: #26a269;
            font-weight: bold;
        }
        
        .unvalidated-bpm {
            color: #666;
            font-style: italic;
        }
        
        .bpm-badge {
            font-size: 0.75em;
            padding: 2px 6px;
            margin-right: 3px;
            margin-bottom: 3px;
            display: inline-block;
        }
        
        .localidade-bpm-info {
            font-size: 0.85em;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 4px 8px;
            margin-top: 4px;
            border-left: 3px solid #1a5fb4;
        }
        
        .pdf-week-section {
            page-break-inside: avoid;
            margin-bottom: 15px;
        }
        
        .insights-container {
            margin-top: 15px;
        }
        
        .cpa-municipio-group {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #1a5fb4;
        }
        
        .coverage-badge {
            font-size: 0.8em;
            padding: 3px 8px;
            margin-left: 5px;
        }
        
        .day-localidades-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .localidade-item {
            background-color: white;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #26a269;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .localidade-item-header {
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .localidade-item-details {
            font-size: 0.75em;
            color: #666;
        }
        
        .localidade-item-badges {
            margin-top: 4px;
        }
        
        .localidade-item .badge {
            font-size: 0.7em;
            padding: 2px 5px;
            margin-right: 2px;
            margin-bottom: 2px;
        }
        
        .day-summary {
            background-color: #e9f7ff;
            border-radius: 4px;
            padding: 4px 8px;
            margin-top: 8px;
            font-size: 0.75em;
            border-left: 3px solid #1a5fb4;
        }
        
        .day-total-badge {
            background-color: #1a5fb4;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .compact-localidade {
            padding: 4px 6px;
            margin-bottom: 4px;
            border-radius: 4px;
            background-color: white;
            border-left: 2px solid #1a5fb4;
            font-size: 0.8em;
        }
        
        .compact-localidade-header {
            font-weight: bold;
            font-size: 0.85em;
            margin-bottom: 1px;
        }
        
        .compact-localidade-details {
            font-size: 0.7em;
            color: #666;
        }
        
        .compact-badge {
            font-size: 0.65em;
            padding: 1px 4px;
            margin-right: 2px;
        }
        
        .scrollable-localidades {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .scrollable-localidades::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable-localidades::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .scrollable-localidades::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .scrollable-localidades::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        .day-header {
            background-color: #e9f7ff;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #1a5fb4;
        }
        
        .localidade-table {
            width: 100%;
            font-size: 0.8em;
            margin-bottom: 10px;
        }
        
        .localidade-table th {
            background-color: #f8f9fa;
            padding: 4px;
            font-size: 0.75em;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .localidade-table td {
            padding: 4px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .localidade-table tr:last-child td {
            border-bottom: none;
        }
        
        .cpa-group {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #26a269;
        }
        
        .cpa-group-header {
            font-weight: bold;
            color: #1a5fb4;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .week-card {
            margin-bottom: 25px;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .week-card-header {
            background-color: #1a5fb4;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
        }
        
        .day-column {
            padding: 10px;
            border-right: 1px solid #eee;
            min-height: 500px;
        }
        
        .day-column:last-child {
            border-right: none;
        }

        /* Horizontal Planning Table Styles */
        .horizontal-planning-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            margin-bottom: 20px;
        }

        .horizontal-planning-table th {
            background: linear-gradient(135deg, #1a5fb4, #0d47a1);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85em;
            border: 1px solid #0d47a1;
            width: 14.28%;
        }

        .horizontal-planning-table td {
            vertical-align: top;
            padding: 8px;
            border: 1px solid #dee2e6;
            background-color: #fff;
            font-size: 0.75em;
        }

        .horizontal-planning-table .day-date {
            font-size: 0.7em;
            color: rgba(255,255,255,0.9);
            font-weight: normal;
        }

        .loc-card {
            background: linear-gradient(to bottom, #f8f9fa, #fff);
            border-radius: 4px;
            padding: 6px;
            margin-bottom: 6px;
            border-left: 3px solid #26a269;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .loc-card.no-bpm {
            border-left-color: #e5a50a;
        }

        .loc-card-name {
            font-weight: 600;
            font-size: 0.8em;
            color: #212529;
            margin-bottom: 2px;
        }

        .loc-card-details {
            font-size: 0.7em;
            color: #6c757d;
        }

        .loc-card-badges {
            margin-top: 4px;
        }

        .loc-card-badges .badge {
            font-size: 0.65em;
            padding: 2px 5px;
            margin-right: 2px;
        }

        .week-summary-row td {
            background-color: #e9f7ff;
            font-weight: 600;
            text-align: center;
            padding: 6px;
            font-size: 0.75em;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingPdf">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <h4>Gerando PDF...</h4>
        <p>Aguarde um momento</p>
    </div>

    <div class="container" id="fullContent">
        <!-- Header Section -->
        <div class="header-section">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-shield-check"></i> Operacao Barricada Zero</h1>
                    <p class="lead">Analise de dados para planejamento operacional na remocao de barricadas</p>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="card card-custom mb-4">
            <div class="card-header card-header-custom">
                <h5 class="mb-0"><i class="bi bi-upload"></i> Importar Dados</h5>
            </div>
            <div class="card-body">
                <div class="file-input-area mb-3">
                    <i class="bi bi-file-earmark-excel fs-1 text-primary mb-3"></i>
                    <h5>Arraste e solte seu arquivo Excel aqui</h5>
                    <p class="text-muted">ou clique no botao abaixo para selecionar</p>
                    <input type="file" id="fileInput" class="form-control d-none" accept=".xlsx">
                    <button id="selectFileBtn" class="btn btn-custom mt-2">
                        <i class="bi bi-folder2-open"></i> Selecionar Arquivo
                    </button>
                    <div id="fileName" class="mt-3 fw-bold"></div>
                </div>
                <button id="analyzeBtn" class="btn btn-custom w-100">
                    <i class="bi bi-graph-up"></i> Analisar Dados
                </button>
            </div>
        </div>

        <!-- Analysis Results Section -->
        <div id="analysis" class="row"></div>

        <!-- Charts Section -->
        <div id="charts" class="row"></div>

        <!-- Planning Section -->
        <div id="planningSection" style="display: none;">
            <div class="card card-custom mb-4">
                <div class="card-header card-header-custom">
                    <h5 class="mb-0"><i class="bi bi-calendar-week"></i> Planejamento de Acoes Futuras</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="startDateInput" class="form-label fw-bold">
                                <i class="bi bi-calendar-date"></i> Data de Inicio das Proximas Acoes:
                            </label>
                            <input type="date" id="startDateInput" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="weeksInput" class="form-label fw-bold">
                                <i class="bi bi-calendar-week"></i> Numero de Semanas:
                            </label>
                            <select id="weeksInput" class="form-select">
                                <option value="1">1 semana</option>
                                <option value="2">2 semanas</option>
                                <option value="3">3 semanas</option>
                                <option value="4" selected>4 semanas</option>
                                <option value="5">5 semanas</option>
                                <option value="6">6 semanas</option>
                                <option value="7">7 semanas</option>
                                <option value="8">8 semanas</option>
                            </select>
                        </div>
                    </div>
                    <button id="generatePlanningBtn" class="btn btn-custom">
                        <i class="bi bi-calendar-plus"></i> Gerar Planejamento
                    </button>
                </div>
            </div>
            <div id="planning" class="row"></div>
        </div>

        <!-- PDF Export Section -->
        <div id="pdfSection" class="text-center mt-5" style="display: none;">
            <div class="card card-custom">
                <div class="card-body">
                    <h4 class="card-title"><i class="bi bi-file-pdf"></i> Exportar Relatorio</h4>
                    <p class="text-muted">Gere um relatorio PDF estruturado com todas as analises e planejamentos</p>
                    <button id="exportPdfBtn" class="btn btn-custom btn-lg">
                        <i class="bi bi-download"></i> Gerar e Baixar PDF
                    </button>
                    <button id="previewPdfBtn" class="btn btn-outline-primary btn-lg ms-2">
                        <i class="bi bi-eye"></i> Visualizar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set default date to today
        document.getElementById('startDateInput').value = new Date().toISOString().split('T')[0];

        let allData = {
            sortedMunicipios: [],
            sortedLocalidades: [],
            recentByMunicipio: {},
            recentByLocalidade: {},
            totalRem: 0,
            totalVias: 0,
            totalPeso: 0,
            avgPesoPerRem: 0,
            insights: '',
            filteredData: [],
            maxDate: null,
            planningData: null,
            localidadesByMunicipio: {},
            recentLocalidadesByMunicipio: {},
            cpaData: {},
            bpmData: {},
            cpaByMunicipio: {},
            bpmByLocalidade: {},
            recentCPAData: {},
            recentBPMData: {},
            metricsByMunicipio: {},
            bpmToLocalidadesMapping: {},
            localidadeBPMValidation: {},
            bpmValidationData: {},
            cpaByLocalidades: {},
            municipioByLocalidades: {}
        };

        // File selection
        document.getElementById('selectFileBtn').addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || 'Nenhum arquivo selecionado';
            document.getElementById('fileName').textContent = `Arquivo: ${fileName}`;
        });

        document.getElementById('analyzeBtn').addEventListener('click', function() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files.length) {
                alert('Por favor, selecione um arquivo Excel.');
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                const workbook = XLSX.read(data, { type: 'array' });
                processWorkbook(workbook);
            };
            reader.readAsArrayBuffer(file);
        });

        // Funcao para conversao de datas Excel
        function excelDateToJSDateSimple(serial) {
            const excelEpoch = new Date(1899, 11, 30);
            const days = Math.floor(serial);
            
            if (serial >= 60) {
                serial -= 1;
            }
            
            const ms = Math.round(serial * 86400000);
            const date = new Date(excelEpoch.getTime() + ms);
            
            return new Date(date.getFullYear(), date.getMonth(), date.getDate());
        }

        function formatDate(date) {
            if (!(date instanceof Date) || isNaN(date)) return 'Data invalida';
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatDateShort(date) {
            if (!(date instanceof Date) || isNaN(date)) return '--/--';
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        function isWeekday(date) {
            const day = date.getDay();
            return day >= 1 && day <= 5;
        }

        function getNextWeekdays(startDate, numWeeks = 4) {
            const dates = [];
            let current = new Date(startDate);
            
            current.setHours(12, 0, 0, 0);
            
            while (dates.length < numWeeks * 5) {
                if (isWeekday(current)) {
                    dates.push(new Date(current));
                }
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }

        function getDayName(dayIndex) {
            const days = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex'];
            return days[dayIndex] || '';
        }

        function getDayNameFull(dayIndex) {
            const days = ['Segunda-feira', 'Terca-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira'];
            return days[dayIndex] || '';
        }

        // Funcao para normalizar nomes
        function normalizeText(text) {
            if (!text) return '';
            return text.toString()
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^\w\s]/gi, '')
                .trim();
        }

        // Verificar se um BPM atua em uma localidade especifica
        function isBPMValidForLocalidade(bpmName, localidadeNome, bairro, municipioNome, bpmValidationData) {
            if (!bpmName || bpmName === 'Nao informado' || (!localidadeNome && !bairro)) {
                return false;
            }
            
            const normalizedBPM = normalizeText(bpmName);
            const normalizedLocalidade = localidadeNome ? normalizeText(localidadeNome) : '';
            const normalizedBairro = bairro ? normalizeText(bairro) : '';
            const normalizedMunicipio = municipioNome ? normalizeText(municipioNome) : '';
            
            if (!bpmValidationData[normalizedBPM]) {
                return false;
            }
            
            const areasAtuacao = bpmValidationData[normalizedBPM].areas || new Set();
            
            const termosParaVerificar = [];
            if (normalizedLocalidade) termosParaVerificar.push(normalizedLocalidade);
            if (normalizedBairro) termosParaVerificar.push(normalizedBairro);
            if (normalizedMunicipio) termosParaVerificar.push(normalizedMunicipio);
            
            for (const termo of termosParaVerificar) {
                for (const area of areasAtuacao) {
                    if (area.includes(termo) || termo.includes(area)) {
                        return true;
                    }
                }
            }
            
            return false;
        }

        function processWorkbook(workbook) {
            // 1. Processar a aba CPA x BTL
            const cpaBtlSheet = workbook.Sheets['CPA x BTL'];
            if (cpaBtlSheet) {
                const cpaBtlData = XLSX.utils.sheet_to_json(cpaBtlSheet, { 
                    header: 1,
                    defval: ''
                });
                
                allData.bpmValidationData = {};
                
                let bpmColumnIndex = -1;
                let areasAtuacaoColumnIndex = -1;
                
                if (cpaBtlData.length > 0) {
                    const headerRow = cpaBtlData[0];
                    
                    for (let i = 0; i < headerRow.length; i++) {
                        const cellValue = headerRow[i].toString().toLowerCase();
                        if (cellValue.includes('bpm') || cellValue.includes('batalhao') || cellValue.includes('batalhao')) {
                            bpmColumnIndex = i;
                        }
                        if (cellValue.includes('municipio') || cellValue.includes('municipio') || 
                            cellValue.includes('atuacao') || cellValue.includes('atuacao') ||
                            cellValue.includes('bairro') || cellValue.includes('localidade') ||
                            cellValue.includes('area') || cellValue.includes('area')) {
                            areasAtuacaoColumnIndex = i;
                        }
                    }
                    
                    if (bpmColumnIndex !== -1 && areasAtuacaoColumnIndex !== -1) {
                        for (let row = 1; row < cpaBtlData.length; row++) {
                            const bpmName = cpaBtlData[row][bpmColumnIndex];
                            const areasAtuacao = cpaBtlData[row][areasAtuacaoColumnIndex];
                            
                            if (bpmName && areasAtuacao) {
                                const normalizedBPM = normalizeText(bpmName);
                                
                                if (!allData.bpmValidationData[normalizedBPM]) {
                                    allData.bpmValidationData[normalizedBPM] = {
                                        originalName: bpmName,
                                        areas: new Set()
                                    };
                                }
                                
                                const areasList = areasAtuacao.toString()
                                    .split(/[,;]/)
                                    .map(area => normalizeText(area.trim()))
                                    .filter(area => area.length > 0);
                                
                                areasList.forEach(area => {
                                    allData.bpmValidationData[normalizedBPM].areas.add(area);
                                });
                            }
                        }
                    }
                }
            }

            // 2. Processar a aba GLOBAL
            const globalSheet = workbook.Sheets['GLOBAL'];
            if (!globalSheet) {
                alert('Aba GLOBAL nao encontrada.');
                return;
            }

            const globalData = XLSX.utils.sheet_to_json(globalSheet, { 
                header: ['DATA', 'AREA', 'MUNICIPIO', 'BAIRRO', 'LOCALIDADE', 'REMOCOES', 'VIAS', 'PESO_TON', 'CPA', 'CMTE', 'BPM'], 
                skipHeader: true 
            });
            
            allData.filteredData = globalData.filter(row => row.DATA && row.REMOCOES > 0);

            allData.filteredData.forEach(row => {
                try {
                    if (typeof row.DATA === 'number') {
                        row.DATA = excelDateToJSDateSimple(row.DATA);
                    } else if (row.DATA instanceof Date) {
                        // Ja e uma data
                    } else {
                        row.DATA = new Date(row.DATA);
                    }
                    
                    if (!(row.DATA instanceof Date) || isNaN(row.DATA.getTime())) {
                        row.DATA = new Date();
                    }
                    
                    row.FORMATTED_DATA = formatDate(row.DATA);
                    row.REMOCOES = parseFloat(row.REMOCOES) || 0;
                    row.VIAS = parseFloat(row.VIAS) || 0;
                    row.PESO_TON = parseFloat(row.PESO_TON) || 0;
                    row.CPA = row.CPA || 'Nao informado';
                    row.BPM = row.BPM || 'Nao informado';
                    
                    row.LOCALIDADE_ID = row.LOCALIDADE || row.BAIRRO || 'Area nao especificada';
                    row.LOCALIDADE_FULL = `${row.MUNICIPIO || 'Desconhecido'} / ${row.LOCALIDADE_ID}`;
                    
                    row.NORMALIZED_LOCALIDADE = normalizeText(row.LOCALIDADE_ID);
                    row.NORMALIZED_BAIRRO = normalizeText(row.BAIRRO);
                    row.NORMALIZED_MUNICIPIO = normalizeText(row.MUNICIPIO);
                    row.NORMALIZED_BPM = normalizeText(row.BPM);
                } catch (error) {
                    console.error('Erro ao processar linha:', row, error);
                    row.DATA = new Date();
                    row.FORMATTED_DATA = formatDate(row.DATA);
                    row.REMOCOES = parseFloat(row.REMOCOES) || 0;
                    row.VIAS = parseFloat(row.VIAS) || 0;
                    row.PESO_TON = parseFloat(row.PESO_TON) || 0;
                    row.CPA = row.CPA || 'Nao informado';
                    row.BPM = row.BPM || 'Nao informado';
                    row.LOCALIDADE_ID = row.LOCALIDADE || row.BAIRRO || 'Area nao especificada';
                    row.LOCALIDADE_FULL = `${row.MUNICIPIO || 'Desconhecido'} / ${row.LOCALIDADE_ID}`;
                    row.NORMALIZED_LOCALIDADE = normalizeText(row.LOCALIDADE_ID);
                    row.NORMALIZED_BAIRro = normalizeText(row.BAIRRO);
                    row.NORMALIZED_MUNICIPIO = normalizeText(row.MUNICIPIO);
                    row.NORMALIZED_BPM = normalizeText(row.BPM);
                }
            });

            // Calculate metrics
            const metricsByMunicipio = {};
            const metricsByLocalidade = {};
            
            allData.localidadesByMunicipio = {};
            allData.metricsByMunicipio = {};
            allData.cpaData = {};
            allData.bpmData = {};
            allData.cpaByMunicipio = {};
            allData.bpmByLocalidade = {};
            allData.localidadeBPMValidation = {};
            allData.bpmToLocalidadesMapping = {};
            allData.cpaByLocalidades = {};
            allData.municipioByLocalidades = {};
            
            allData.filteredData.forEach(row => {
                const mun = row.MUNICIPIO || 'Desconhecido';
                const locId = row.LOCALIDADE_ID;
                const locFull = row.LOCALIDADE_FULL;
                const bairro = row.BAIRRO;
                const cpa = row.CPA;
                const bpm = row.BPM;
                
                const isBPMValid = isBPMValidForLocalidade(
                    bpm, 
                    row.LOCALIDADE, 
                    bairro, 
                    mun, 
                    allData.bpmValidationData
                );
                
                if (!metricsByMunicipio[mun]) {
                    metricsByMunicipio[mun] = { 
                        rem: 0, 
                        vias: 0, 
                        peso: 0,
                        localidades: new Set(),
                        todasLocalidades: []
                    };
                }
                metricsByMunicipio[mun].rem += row.REMOCOES;
                metricsByMunicipio[mun].vias += row.VIAS;
                metricsByMunicipio[mun].peso += row.PESO_TON;
                metricsByMunicipio[mun].localidades.add(locId);
                
                if (!metricsByLocalidade[locFull]) {
                    metricsByLocalidade[locFull] = { 
                        rem: 0, 
                        vias: 0, 
                        peso: 0, 
                        municipio: mun,
                        bairro: bairro,
                        validBPMs: new Set(),
                        allBPMs: new Set(),
                        isValidForPlanning: false,
                        cpa: cpa
                    };
                }
                metricsByLocalidade[locFull].rem += row.REMOCOES;
                metricsByLocalidade[locFull].vias += row.VIAS;
                metricsByLocalidade[locFull].peso += row.PESO_TON;
                metricsByLocalidade[locFull].allBPMs.add(bpm);
                if (isBPMValid && bpm !== 'Nao informado') {
                    metricsByLocalidade[locFull].validBPMs.add(bpm);
                    metricsByLocalidade[locFull].isValidForPlanning = true;
                }

                if (!allData.localidadesByMunicipio[mun]) {
                    allData.localidadesByMunicipio[mun] = {};
                }
                if (!allData.localidadesByMunicipio[mun][locFull]) {
                    allData.localidadesByMunicipio[mun][locFull] = { 
                        rem: 0, 
                        vias: 0, 
                        peso: 0,
                        bairro: bairro,
                        validBPMs: new Set(),
                        allBPMs: new Set(),
                        cpa: cpa
                    };
                }
                allData.localidadesByMunicipio[mun][locFull].rem += row.REMOCOES;
                allData.localidadesByMunicipio[mun][locFull].vias += row.VIAS;
                allData.localidadesByMunicipio[mun][locFull].peso += row.PESO_TON;
                allData.localidadesByMunicipio[mun][locFull].allBPMs.add(bpm);
                if (isBPMValid && bpm !== 'Nao informado') {
                    allData.localidadesByMunicipio[mun][locFull].validBPMs.add(bpm);
                }
                
                if (!allData.metricsByMunicipio[mun]) {
                    allData.metricsByMunicipio[mun] = { 
                        rem: 0, 
                        vias: 0, 
                        peso: 0,
                        localidades: new Set(),
                        cpas: new Set(),
                        bpms: new Set()
                    };
                }
                allData.metricsByMunicipio[mun].rem += row.REMOCOES;
                allData.metricsByMunicipio[mun].vias += row.VIAS;
                allData.metricsByMunicipio[mun].peso += row.PESO_TON;
                allData.metricsByMunicipio[mun].localidades.add(locId);
                allData.metricsByMunicipio[mun].cpas.add(cpa);
                allData.metricsByMunicipio[mun].bpms.add(bpm);

                if (!allData.cpaData[cpa]) {
                    allData.cpaData[cpa] = { rem: 0, municipios: new Set(), localidades: new Set() };
                }
                allData.cpaData[cpa].rem += row.REMOCOES;
                allData.cpaData[cpa].municipios.add(mun);
                allData.cpaData[cpa].localidades.add(locFull);

                if (!allData.bpmData[bpm]) {
                    allData.bpmData[bpm] = { 
                        rem: 0, 
                        municipios: new Set(), 
                        localidades: new Set(), 
                        isValid: false 
                    };
                }
                allData.bpmData[bpm].rem += row.REMOCOES;
                allData.bpmData[bpm].municipios.add(mun);
                allData.bpmData[bpm].localidades.add(locFull);
                allData.bpmData[bpm].isValid = isBPMValid;

                if (!allData.cpaByMunicipio[mun]) {
                    allData.cpaByMunicipio[mun] = {};
                }
                if (!allData.cpaByMunicipio[mun][cpa]) {
                    allData.cpaByMunicipio[mun][cpa] = 0;
                }
                allData.cpaByMunicipio[mun][cpa] += row.REMOCOES;

                if (!allData.bpmByLocalidade[locFull]) {
                    allData.bpmByLocalidade[locFull] = {};
                }
                if (isBPMValid && bpm !== 'Nao informado') {
                    if (!allData.bpmByLocalidade[locFull][bpm]) {
                        allData.bpmByLocalidade[locFull][bpm] = 0;
                    }
                    allData.bpmByLocalidade[locFull][bpm] += row.REMOCOES;
                    
                    if (!allData.bpmToLocalidadesMapping[bpm]) {
                        allData.bpmToLocalidadesMapping[bpm] = new Set();
                    }
                    allData.bpmToLocalidadesMapping[bpm].add(locFull);
                }
                
                if (!allData.localidadeBPMValidation[locFull]) {
                    allData.localidadeBPMValidation[locFull] = {
                        validBPMs: new Set(),
                        allBPMs: new Set(),
                        municipio: mun,
                        bairro: bairro,
                        cpa: cpa
                    };
                }
                allData.localidadeBPMValidation[locFull].allBPMs.add(bpm);
                if (isBPMValid && bpm !== 'Nao informado') {
                    allData.localidadeBPMValidation[locFull].validBPMs.add(bpm);
                }
                
                // Estrutura para agrupamento por CPA
                if (!allData.cpaByLocalidades[cpa]) {
                    allData.cpaByLocalidades[cpa] = [];
                }
                if (!allData.cpaByLocalidades[cpa].includes(locFull)) {
                    allData.cpaByLocalidades[cpa].push(locFull);
                }
                
                // Estrutura para agrupamento por Municipio
                if (!allData.municipioByLocalidades[mun]) {
                    allData.municipioByLocalidades[mun] = [];
                }
                if (!allData.municipioByLocalidades[mun].includes(locFull)) {
                    allData.municipioByLocalidades[mun].push(locFull);
                }
            });

            allData.sortedMunicipios = Object.entries(metricsByMunicipio)
                .sort((a, b) => b[1].rem - a[1].rem);
            
            allData.sortedLocalidades = Object.entries(metricsByLocalidade)
                .sort((a, b) => b[1].rem - a[1].rem);

            // Recent metrics (last 7 days)
            allData.maxDate = new Date(Math.max(...allData.filteredData.map(row => row.DATA)));
            const sevenDaysAgo = new Date(allData.maxDate);
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            sevenDaysAgo.setHours(0, 0, 0, 0);
            
            const recentData = allData.filteredData.filter(row => {
                const rowDate = new Date(row.DATA);
                rowDate.setHours(0, 0, 0, 0);
                return rowDate >= sevenDaysAgo;
            });

            allData.recentByMunicipio = {};
            allData.recentByLocalidade = {};
            allData.recentLocalidadesByMunicipio = {};
            allData.recentCPAData = {};
            allData.recentBPMData = {};
            
            recentData.forEach(row => {
                const mun = row.MUNICIPIO || 'Desconhecido';
                const locId = row.LOCALIDADE_ID;
                const locFull = row.LOCALIDADE_FULL;
                const bairro = row.BAIRRO;
                const cpa = row.CPA;
                const bpm = row.BPM;
                
                const isBPMValid = isBPMValidForLocalidade(
                    bpm, 
                    row.LOCALIDADE, 
                    bairro, 
                    mun, 
                    allData.bpmValidationData
                );
                
                if (!allData.recentByMunicipio[mun]) {
                    allData.recentByMunicipio[mun] = { 
                        rem: 0, 
                        vias: 0, 
                        peso: 0,
                        localidades: new Set()
                    };
                }
                allData.recentByMunicipio[mun].rem += row.REMOCOES;
                allData.recentByMunicipio[mun].vias += row.VIAS;
                allData.recentByMunicipio[mun].peso += row.PESO_TON;
                allData.recentByMunicipio[mun].localidades.add(locFull);

                if (!allData.recentByLocalidade[locFull]) {
                    allData.recentByLocalidade[locFull] = { 
                        rem: 0, 
                        vias: 0, 
                        peso: 0,
                        municipio: mun,
                        bairro: bairro,
                        validBPMs: new Set(),
                        allBPMs: new Set(),
                        isValidForPlanning: false,
                        cpa: cpa
                    };
                }
                allData.recentByLocalidade[locFull].rem += row.REMOCOES;
                allData.recentByLocalidade[locFull].vias += row.VIAS;
                allData.recentByLocalidade[locFull].peso += row.PESO_TON;
                allData.recentByLocalidade[locFull].allBPMs.add(bpm);
                if (isBPMValid && bpm !== 'Nao informado') {
                    allData.recentByLocalidade[locFull].validBPMs.add(bpm);
                    allData.recentByLocalidade[locFull].isValidForPlanning = true;
                }
                
                if (!allData.recentLocalidadesByMunicipio[mun]) {
                    allData.recentLocalidadesByMunicipio[mun] = {};
                }
                if (!allData.recentLocalidadesByMunicipio[mun][locFull]) {
                    allData.recentLocalidadesByMunicipio[mun][locFull] = { 
                        rem: 0, 
                        vias: 0, 
                        peso: 0,
                        bairro: bairro,
                        validBPMs: new Set(),
                        allBPMs: new Set()
                    };
                }
                allData.recentLocalidadesByMunicipio[mun][locFull].rem += row.REMOCOES;
                allData.recentLocalidadesByMunicipio[mun][locFull].vias += row.VIAS;
                allData.recentLocalidadesByMunicipio[mun][locFull].peso += row.PESO_TON;
                allData.recentLocalidadesByMunicipio[mun][locFull].allBPMs.add(bpm);
                if (isBPMValid && bpm !== 'Nao informado') {
                    allData.recentLocalidadesByMunicipio[mun][locFull].validBPMs.add(bpm);
                }

                if (!allData.recentCPAData[cpa]) {
                    allData.recentCPAData[cpa] = { rem: 0, municipios: new Set(), localidades: new Set() };
                }
                allData.recentCPAData[cpa].rem += row.REMOCOES;
                allData.recentCPAData[cpa].municipios.add(mun);
                allData.recentCPAData[cpa].localidades.add(locFull);

                if (isBPMValid && bpm !== 'Nao informado') {
                    if (!allData.recentBPMData[bpm]) {
                        allData.recentBPMData[bpm] = { 
                            rem: 0, 
                            municipios: new Set(), 
                            localidades: new Set(), 
                            isValid: true 
                        };
                    }
                    allData.recentBPMData[bpm].rem += row.REMOCOES;
                    allData.recentBPMData[bpm].municipios.add(mun);
                    allData.recentBPMData[bpm].localidades.add(locFull);
                }
            });

            // Calculate totals
            allData.totalRem = allData.filteredData.reduce((sum, row) => sum + row.REMOCOES, 0);
            allData.totalVias = allData.filteredData.reduce((sum, row) => sum + row.VIAS, 0);
            allData.totalPeso = allData.filteredData.reduce((sum, row) => sum + row.PESO_TON, 0);
            allData.avgPesoPerRem = allData.totalRem > 0 ? (allData.totalPeso / allData.totalRem).toFixed(2) : 0;

            // Generate insights
            generateInsights();

            // Render analysis
            renderAnalysis();
            renderCharts();

            // Show planning section
            document.getElementById('planningSection').style.display = 'block';
            document.getElementById('pdfSection').style.display = 'block';
        }

        function generateInsights() {
            let insights = '';
            
            const localidadesComBPMValido = Object.values(allData.localidadeBPMValidation)
                .filter(loc => loc.validBPMs && loc.validBPMs.size > 0)
                .length;
            
            const totalLocalidades = Object.keys(allData.localidadeBPMValidation).length;
            
            insights += `
                <div class="insight-card p-3 mb-3">
                    <h6><i class="bi bi-shield-check text-success"></i> Validacao de BPMs por Localidade</h6>
                    <p class="mb-1">${localidadesComBPMValido} de ${totalLocalidades} localidades tem BPMs validados para atuacao</p>
                    <small class="text-muted">BPMs sao associados especificamente a cada localidade, permitindo multiplos BPMs por municipio</small>
                </div>`;
            
            if (allData.sortedMunicipios.length > 0) {
                const topMun = allData.sortedMunicipios[0][0];
                const topMunData = allData.sortedMunicipios[0][1];
                
                let localidadesComBPMValidoNoMunicipio = 0;
                if (allData.localidadesByMunicipio[topMun]) {
                    Object.values(allData.localidadesByMunicipio[topMun]).forEach(loc => {
                        if (loc.validBPMs && loc.validBPMs.size > 0) {
                            localidadesComBPMValidoNoMunicipio++;
                        }
                    });
                }
                
                insights += `
                    <div class="insight-card p-3 mb-3">
                        <h6><i class="bi bi-exclamation-triangle-fill text-warning"></i> Prioridade Maxima: ${topMun}</h6>
                        <p class="mb-1">${topMunData.rem} remocoes | ${topMunData.peso.toFixed(1)} ton | ${topMunData.localidades.size} localidades</p>
                        <p class="mb-1"><i class="bi bi-shield-check"></i> ${localidadesComBPMValidoNoMunicipio} localidades com BPMs validados</p>
                        <small class="text-muted">Recomendacao: Coordenar acoes com os BPMs especificos de cada localidade</small>
                    </div>`;
            }

            if (allData.sortedLocalidades.length > 0) {
                const topLocEntry = allData.sortedLocalidades[0];
                const topLoc = topLocEntry[0];
                const topLocData = topLocEntry[1];
                const validBPMsCount = topLocData.validBPMs ? topLocData.validBPMs.size : 0;
                const bpmList = topLocData.validBPMs ? Array.from(topLocData.validBPMs).join(', ') : 'Nenhum';
                
                insights += `
                    <div class="insight-card p-3 mb-3">
                        <h6><i class="bi bi-geo-alt-fill text-danger"></i> Focal Point: ${topLoc}</h6>
                        <p class="mb-1">${topLocData.rem} remocoes | ${topLocData.peso.toFixed(1)} ton | ${topLocData.vias} vias</p>
                        <p class="mb-1"><i class="bi bi-shield-check"></i> BPMs validados: ${validBPMsCount} (${bpmList})</p>
                        <small class="text-muted">Recomendacao: Implementar operacao especial com os BPMs especificos desta localidade</small>
                    </div>`;
            }

            allData.insights = insights;
        }

        function renderAnalysis() {
            let html = '';
            
            // Summary Cards
            html += `
                <div class="col-12 mb-4">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card card-custom h-100">
                                <div class="card-body stat-card">
                                    <div class="stat-value">${allData.totalRem.toLocaleString()}</div>
                                    <div class="stat-label">Total de Remocoes</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card card-custom h-100">
                                <div class="card-body stat-card priority-medium">
                                    <div class="stat-value">${allData.totalVias.toLocaleString()}</div>
                                    <div class="stat-label">Vias Afetadas</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card card-custom h-100">
                                <div class="card-body stat-card priority-high">
                                    <div class="stat-value">${allData.totalPeso.toFixed(1)}</div>
                                    <div class="stat-label">Peso Total (ton)</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card card-custom h-100">
                                <div class="card-body stat-card priority-low">
                                    <div class="stat-value">${allData.sortedMunicipios.length}</div>
                                    <div class="stat-label">Municipios</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Insights
            html += `
                <div class="col-12 mb-4">
                    <div class="card card-custom">
                        <div class="card-header card-header-custom">
                            <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Insights e Recomendacoes</h5>
                        </div>
                        <div class="card-body">
                            <div class="insights-container">
                                ${allData.insights}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Top 10 Municipalities Table
            html += `
                <div class="col-md-6 mb-4">
                    <div class="card card-custom h-100">
                        <div class="card-header card-header-custom">
                            <h5 class="mb-0"><i class="bi bi-building"></i> Top 10 Municipios</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-custom table-sm">
                                    <thead>
                                        <tr>
                                            <th>Municipio</th>
                                            <th>Remocoes</th>
                                            <th>Peso (ton)</th>
                                            <th>Localidades</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${allData.sortedMunicipios.slice(0, 10).map(([mun, data]) => `
                                            <tr>
                                                <td><strong>${mun}</strong></td>
                                                <td>${data.rem}</td>
                                                <td>${data.peso.toFixed(1)}</td>
                                                <td><span class="badge bg-primary">${data.localidades.size}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Top 10 Localities Table
            html += `
                <div class="col-md-6 mb-4">
                    <div class="card card-custom h-100">
                        <div class="card-header card-header-custom">
                            <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Top 10 Localidades</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-custom table-sm">
                                    <thead>
                                        <tr>
                                            <th>Localidade</th>
                                            <th>Remocoes</th>
                                            <th>Peso (ton)</th>
                                            <th>BPM</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${allData.sortedLocalidades.slice(0, 10).map(([loc, data]) => {
                                            const hasBPM = data.validBPMs && data.validBPMs.size > 0;
                                            const bpmBadge = hasBPM ? 
                                                `<span class="badge bg-success">${data.validBPMs.size}</span>` : 
                                                `<span class="badge bg-warning">0</span>`;
                                            return `
                                                <tr>
                                                    <td><strong>${loc.split('/')[1]?.trim() || loc}</strong><br><small class="text-muted">${loc.split('/')[0]?.trim()}</small></td>
                                                    <td>${data.rem}</td>
                                                    <td>${data.peso.toFixed(1)}</td>
                                                    <td>${bpmBadge}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('analysis').innerHTML = html;
        }

        function renderCharts() {
            let html = `
                <div class="col-md-6 mb-4">
                    <div class="card card-custom">
                        <div class="card-header card-header-custom">
                            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Remocoes por Municipio</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="municipioChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card card-custom">
                        <div class="card-header card-header-custom">
                            <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Distribuicao de BPMs</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="bpmChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('charts').innerHTML = html;

            // Municipality Chart
            const topMunicipios = allData.sortedMunicipios.slice(0, 10);
            new Chart(document.getElementById('municipioChart'), {
                type: 'bar',
                data: {
                    labels: topMunicipios.map(([mun]) => mun.length > 15 ? mun.substring(0, 12) + '...' : mun),
                    datasets: [{
                        label: 'Remocoes',
                        data: topMunicipios.map(([, data]) => data.rem),
                        backgroundColor: 'rgba(26, 95, 180, 0.7)',
                        borderColor: 'rgba(26, 95, 180, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Localidades com BPM',
                        data: topMunicipios.map(([mun]) => {
                            let count = 0;
                            if (allData.localidadesByMunicipio[mun]) {
                                Object.values(allData.localidadesByMunicipio[mun]).forEach(loc => {
                                    if (loc.validBPMs && loc.validBPMs.size > 0) {
                                        count++;
                                    }
                                });
                            }
                            return count;
                        }),
                        backgroundColor: 'rgba(38, 162, 105, 0.7)',
                        borderColor: 'rgba(38, 162, 105, 1)',
                        borderWidth: 1,
                        type: 'line',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Remocoes'
                            }
                        },
                        y1: {
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Localidades com BPMs'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                }
                }
            });

            // BPM Chart
            const topLocalidadesComBPM = allData.sortedLocalidades
                .filter(([loc, data]) => data.validBPMs && data.validBPMs.size > 0)
                .slice(0, 10);
            
            new Chart(document.getElementById('bpmChart'), {
                type: 'doughnut',
                data: {
                    labels: topLocalidadesComBPM.map(([loc]) => loc.split('/')[1]?.trim() || loc),
                    datasets: [{
                        data: topLocalidadesComBPM.map(([, data]) => data.validBPMs ? data.validBPMs.size : 0),
                        backgroundColor: [
                            '#1a5fb4', '#26a269', '#e5a50a', '#e01b24',
                            '#613583', '#c64600', '#1a9998', '#7e4b8b',
                            '#2aa1af', '#ff6b6b'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12
                            }
                        }
                    }
                }
            });
        }

        // NOVA FUNÇÃO: Distribuição inteligente de localidades com rodízio
        function distribuirLocalidadesInteligente(localidadesComDados, totalDias, mediaDesejada = 8) {
            // Ordenar localidades por prioridade (remoções, peso, vias)
            const localidadesOrdenadas = [...localidadesComDados].sort((a, b) => {
                const prioridadeA = (a.data.rem * 2) + (a.data.peso * 0.5) + (a.data.vias * 0.3);
                const prioridadeB = (b.data.rem * 2) + (b.data.peso * 0.5) + (b.data.vias * 0.3);
                return prioridadeB - prioridadeA;
            });
            
            // Inicializar array de distribuição
            const distribuicao = Array.from({ length: totalDias }, () => []);
            
            // Controlar repetição de CPA no mesmo dia
            const cpasPorDia = Array.from({ length: totalDias }, () => new Set());
            
            // Distribuir localidades
            let diaAtual = 0;
            let localidadesAtribuidas = 0;
            const maxPorDia = Math.ceil(localidadesOrdenadas.length / totalDias) + 2;
            
            localidadesOrdenadas.forEach((localidade, index) => {
                let melhorDia = -1;
                let melhorPontuacao = -1;
                
                // Encontrar melhor dia para esta localidade
                for (let d = 0; d < totalDias; d++) {
                    // Verificar se o dia já tem muitas localidades
                    if (distribuicao[d].length >= maxPorDia) continue;
                    
                    let pontuacao = 0;
                    
                    // Preferir dias com menos localidades
                    pontuacao += (maxPorDia - distribuicao[d].length) * 10;
                    
                    // Penalizar dias que já têm a mesma CPA
                    if (cpasPorDia[d].has(localidade.cpa)) {
                        pontuacao -= 50;
                    }
                    
                    // Preferir distribuir localidades da mesma CPA em dias diferentes
                    const diasComMesmaCPA = cpasPorDia.reduce((count, cpas, idx) => 
                        cpas.has(localidade.cpa) ? count + 1 : count, 0);
                    if (diasComMesmaCPA === 0) {
                        pontuacao += 20; // Primeira vez que esta CPA aparece
                    }
                    
                    // Alternar entre dias para evitar concentração
                    const distanciaDoUltimo = Math.abs(d - diaAtual);
                    pontuacao += (5 - distanciaDoUltimo) * 2;
                    
                    if (pontuacao > melhorPontuacao) {
                        melhorPontuacao = pontuacao;
                        melhorDia = d;
                    }
                }
                
                // Se não encontrou dia adequado, usar o dia com menos localidades
                if (melhorDia === -1) {
                    melhorDia = distribuicao.reduce((minIndex, dia, index) => 
                        dia.length < distribuicao[minIndex].length ? index : minIndex, 0);
                }
                
                // Atribuir localidade ao dia
                distribuicao[melhorDia].push(localidade);
                cpasPorDia[melhorDia].add(localidade.cpa);
                diaAtual = melhorDia;
                localidadesAtribuidas++;
            });
            
            return distribuicao;
        }

        // FUNÇÃO PRINCIPAL DE PLANEJAMENTO COM NOVA LÓGICA
        document.getElementById('generatePlanningBtn').addEventListener('click', function() {
            const startDateStr = document.getElementById('startDateInput').value;
            const numWeeks = parseInt(document.getElementById('weeksInput').value);
            
            if (!startDateStr) {
                alert('Por favor, selecione uma data valida.');
                return;
            }
            
            const parts = startDateStr.split('-');
            const startDate = new Date(parts[0], parts[1] - 1, parts[2]);
            startDate.setHours(12, 0, 0, 0);
            
            const weekdays = getNextWeekdays(startDate, numWeeks);
            const totalDias = weekdays.length;
            
            // 1. Coletar TODAS as localidades disponiveis
            const todasLocalidades = Object.entries(allData.recentByLocalidade)
                .sort((a, b) => b[1].rem - a[1].rem);
            
            // 2. Processar dados das localidades
            const localidadesComDados = todasLocalidades.map(([locFull, data]) => {
                const [municipio, localidade] = locFull.split(' / ');
                const localidadeNome = localidade || municipio;
                
                let bpmValido = 'BPM nao informado';
                let bpmIsValid = false;
                let todosBPMsValidos = [];
                
                if (data.validBPMs && data.validBPMs.size > 0) {
                    todosBPMsValidos = Array.from(data.validBPMs);
                    bpmValido = todosBPMsValidos[0];
                    bpmIsValid = true;
                } else if (allData.bpmByLocalidade[locFull]) {
                    const bpmEntries = Object.entries(allData.bpmByLocalidade[locFull])
                        .filter(([bpm]) => bpm !== 'Nao informado')
                        .sort((a, b) => b[1] - a[1]);
                    if (bpmEntries.length > 0) {
                        bpmValido = bpmEntries[0][0];
                        bpmIsValid = true;
                        todosBPMsValidos = [bpmValido];
                    }
                }
                
                let cpaParaLocalidade = data.cpa || 'CPA nao informada';
                if (!cpaParaLocalidade || cpaParaLocalidade === 'CPA nao informada') {
                    if (allData.cpaByMunicipio[municipio]) {
                        const cpaEntries = Object.entries(allData.cpaByMunicipio[municipio])
                            .filter(([cpa]) => cpa !== 'Nao informado')
                            .sort((a, b) => b[1] - a[1]);
                        if (cpaEntries.length > 0) {
                            cpaParaLocalidade = cpaEntries[0][0];
                        }
                    }
                }
                
                const intensityLevel = data.rem > 10 ? 'ALTA' : 
                                     data.rem > 5 ? 'MEDIA' : 'MODERADA';
                
                return {
                    locFull: locFull,
                    municipio: municipio,
                    localidadeNome: localidadeNome,
                    data: data,
                    cpa: cpaParaLocalidade,
                    bpm: bpmValido,
                    bpmIsValid: bpmIsValid,
                    todosBPMsValidos: todosBPMsValidos,
                    intensityLevel: intensityLevel,
                    intensityColor: intensityLevel === 'ALTA' ? 'bg-danger' : 
                                   intensityLevel === 'MEDIA' ? 'bg-warning' : 'bg-info'
                };
            });
            
            // 3. Distribuir localidades usando a nova lógica inteligente
            const distribuicaoPorDia = distribuirLocalidadesInteligente(localidadesComDados, totalDias, 8);
            
            // 4. Agrupar localidades por CPA e Município para estatísticas
            const localidadesPorCPA = {};
            const localidadesPorMunicipio = {};
            
            localidadesComDados.forEach(loc => {
                if (!localidadesPorCPA[loc.cpa]) {
                    localidadesPorCPA[loc.cpa] = [];
                }
                localidadesPorCPA[loc.cpa].push(loc);
                
                if (!localidadesPorMunicipio[loc.municipio]) {
                    localidadesPorMunicipio[loc.municipio] = [];
                }
                localidadesPorMunicipio[loc.municipio].push(loc);
            });
            
            // 5. Armazenar dados do planejamento
            allData.planningData = {
                startDate: startDate,
                numWeeks: numWeeks,
                weekdays: weekdays,
                distribuicaoPorDia: distribuicaoPorDia,
                localidadesComDados: localidadesComDados,
                localidadesPorCPA: localidadesPorCPA,
                localidadesPorMunicipio: localidadesPorMunicipio,
                semanas: Math.ceil(weekdays.length / 5)
            };
            
            // 6. Renderizar planejamento com a nova distribuição
            renderPlanningCompleto(distribuicaoPorDia, weekdays, numWeeks, localidadesPorCPA, localidadesPorMunicipio);
        });

        // FUNÇÃO PARA RENDERIZAR PLANEJAMENTO COMPLETO COM NOVA DISTRIBUIÇÃO
        function renderPlanningCompleto(distribuicaoPorDia, weekdays, numWeeks, localidadesPorCPA, localidadesPorMunicipio) {
            const totalLocalidades = distribuicaoPorDia.flat().length;
            const localidadesComBPMValido = distribuicaoPorDia.flat().filter(loc => loc.bpmIsValid).length;
            const semanas = Math.ceil(weekdays.length / 5);
            
            // Calcular estatísticas de distribuição
            const estatisticasDias = distribuicaoPorDia.map((dia, idx) => ({
                dia: idx + 1,
                total: dia.length,
                comBPM: dia.filter(loc => loc.bpmIsValid).length,
                cpas: new Set(dia.map(loc => loc.cpa)).size
            }));
            
            const mediaPorDia = (totalLocalidades / weekdays.length).toFixed(1);
            const maxPorDia = Math.max(...estatisticasDias.map(d => d.total));
            const minPorDia = Math.min(...estatisticasDias.map(d => d.total));
            
            let planningHtml = `
                <div class="col-12">
                    <div class="card card-custom">
                        <div class="card-header card-header-custom">
                            <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Planejamento Otimizado - ${numWeeks} Semanas</h5>
                            <small class="text-white">Distribuição inteligente com rodízio de CPA e média de ${mediaPorDia} localidades/dia</small>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-success mb-4">
                                <i class="bi bi-check-circle"></i>
                                <strong>PLANEJAMENTO OTIMIZADO GERADO</strong><br>
                                <strong>Localidades Totais:</strong> ${totalLocalidades}<br>
                                <strong>Localidades com BPMs Validados:</strong> ${localidadesComBPMValido} (${Math.round((localidadesComBPMValido/totalLocalidades)*100)}%)<br>
                                <strong>Semanas de Atuacao:</strong> ${semanas} semanas (${weekdays.length} dias uteis)<br>
                                <strong>Média por Dia:</strong> ${mediaPorDia} localidades (máx: ${maxPorDia}, mín: ${minPorDia})<br>
                                <strong>CPAs Envolvidas:</strong> ${Object.keys(localidadesPorCPA).length}<br>
                                <strong>Municipios Envolvidos:</strong> ${Object.keys(localidadesPorMunicipio).length}
                            </div>
                            
                            <div class="alert alert-info mb-4">
                                <i class="bi bi-info-circle"></i>
                                <strong>Nova Lógica de Distribuição:</strong><br>
                                1. Rodízio inteligente para evitar repetição de CPA no mesmo dia<br>
                                2. Média controlada de 8 localidades por dia<br>
                                3. Priorização por criticidade (remoções, peso, vias)<br>
                                4. Distribuição equilibrada entre os dias
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Distribuição por Dia</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Dia</th>
                                                            <th>Localidades</th>
                                                            <th>Com BPM</th>
                                                            <th>CPAs</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${estatisticasDias.map(est => `
                                                            <tr>
                                                                <td>Dia ${est.dia}</td>
                                                                <td><span class="badge ${est.total >= 8 ? 'bg-success' : 'bg-warning'}">${est.total}</span></td>
                                                                <td><span class="badge ${est.comBPM > 0 ? 'bg-success' : 'bg-secondary'}">${est.comBPM}</span></td>
                                                                <td><span class="badge bg-info">${est.cpas}</span></td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0"><i class="bi bi-pie-chart"></i> Estatísticas Gerais</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="text-center">
                                                        <div class="display-6 text-primary">${mediaPorDia}</div>
                                                        <small class="text-muted">Média/Dia</small>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="text-center">
                                                        <div class="display-6 text-success">${localidadesComBPMValido}</div>
                                                        <small class="text-muted">Com BPM</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <div class="progress mb-2">
                                                    <div class="progress-bar bg-success" style="width: ${(localidadesComBPMValido/totalLocalidades)*100}%">
                                                        ${Math.round((localidadesComBPMValido/totalLocalidades)*100)}% com BPM
                                                    </div>
                                                </div>
                                                <small>${totalLocalidades - localidadesComBPMValido} localidades sem BPM validado</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
            `;

            // Para cada semana
            for (let week = 0; week < semanas; week++) {
                const weekStart = week * 5;
                const weekDates = weekdays.slice(weekStart, weekStart + 5);
                const semanaNum = week + 1;
                
                planningHtml += `
                    <div class="card card-custom mb-4">
                        <div class="card-header card-header-custom">
                            <h5 class="mb-0">Semana ${semanaNum}: ${formatDate(weekDates[0])} a ${formatDate(weekDates[4] || weekDates[weekDates.length - 1])}</h5>
                            <small class="text-white">Distribuição equilibrada por dia</small>
                        </div>
                        <div class="card-body">
                `;
                
                // Para cada dia da semana
                for (let dia = 0; dia < 5; dia++) {
                    if (weekDates[dia]) {
                        const date = weekDates[dia];
                        const diaGlobalIndex = week * 5 + dia;
                        const localidadesDoDia = distribuicaoPorDia[diaGlobalIndex] || [];
                        
                        // Agrupar localidades do dia por CPA
                        const cpasDoDia = {};
                        localidadesDoDia.forEach(loc => {
                            if (!cpasDoDia[loc.cpa]) {
                                cpasDoDia[loc.cpa] = [];
                            }
                            cpasDoDia[loc.cpa].push(loc);
                        });
                        
                        const cpasOrdenadasDoDia = Object.keys(cpasDoDia)
                            .sort((a, b) => cpasDoDia[b].length - cpasDoDia[a].length);
                        
                        planningHtml += `
                            <div class="day-header mb-3">
                                <h6><i class="bi bi-calendar-day"></i> ${formatDate(date)} - ${getDayNameFull(dia)}</h6>
                                <div class="day-summary">
                                    <span class="day-total-badge">${localidadesDoDia.length} loc.</span>
                                    <span class="badge bg-success ms-1">${localidadesDoDia.filter(loc => loc.bpmIsValid).length} com BPM</span>
                                    <span class="badge bg-primary ms-1">${Object.keys(cpasDoDia).length} CPAs</span>
                                </div>
                            </div>
                        `;
                        
                        if (cpasOrdenadasDoDia.length === 0) {
                            planningHtml += `<div class="alert alert-warning mb-4">Nenhuma localidade agendada para este dia.</div>`;
                        } else {
                            planningHtml += `<div class="scrollable-localidades mb-4">`;
                            
                            cpasOrdenadasDoDia.forEach(cpa => {
                                const localidadesCPA = cpasDoDia[cpa];
                                
                                planningHtml += `
                                    <div class="cpa-group">
                                        <div class="cpa-group-header">
                                            <i class="bi bi-shield"></i> ${cpa} 
                                            <span class="badge bg-primary">${localidadesCPA.length} loc.</span>
                                            <span class="badge bg-success">${localidadesCPA.filter(l => l.bpmIsValid).length} com BPM</span>
                                        </div>
                                        <table class="localidade-table">
                                            <thead>
                                                <tr>
                                                    <th width="35%">Localidade</th>
                                                    <th width="25%">Município</th>
                                                    <th width="20%">BPM</th>
                                                    <th width="20%">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                `;
                                
                                localidadesCPA.sort((a, b) => a.municipio.localeCompare(b.municipio));
                                
                                localidadesCPA.forEach(localidade => {
                                    const bpmStatus = localidade.bpmIsValid ? 
                                        `<span class="badge bg-success compact-badge">${localidade.bpm}</span>` :
                                        `<span class="badge bg-warning compact-badge">${localidade.bpm}</span>`;
                                    
                                    planningHtml += `
                                        <tr>
                                            <td>
                                                <strong>${localidade.localidadeNome}</strong><br>
                                                <small class="text-muted">${localidade.data.rem} rem | ${localidade.data.peso.toFixed(1)} ton</small>
                                            </td>
                                            <td>${localidade.municipio}</td>
                                            <td>${bpmStatus}</td>
                                            <td>
                                                <span class="badge ${localidade.intensityColor} compact-badge">${localidade.intensityLevel}</span>
                                                ${localidade.bpmIsValid ? 
                                                    '<span class="badge bg-success compact-badge">BPM OK</span>' : 
                                                    '<span class="badge bg-warning compact-badge">Sem BPM</span>'
                                                }
                                            </td>
                                        </tr>
                                    `;
                                });
                                
                                planningHtml += `
                                            </tbody>
                                        </table>
                                    </div>
                                `;
                            });
                            
                            planningHtml += `</div>`;
                        }
                        
                        if (dia < 4) {
                            planningHtml += `<hr class="my-4">`;
                        }
                    }
                }
                
                planningHtml += `
                        </div>
                    </div>
                `;
            }

            // Resumo Estatistico
            planningHtml += `
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-shield"></i> Top CPAs por Localidades</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>CPA</th>
                                                    <th>Localidades</th>
                                                    <th>Com BPM</th>
                                                    <th>Distribuição/Dia</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(localidadesPorCPA)
                                                    .sort((a, b) => b[1].length - a[1].length)
                                                    .slice(0, 10)
                                                    .map(([cpa, locs]) => {
                                                        const comBPM = locs.filter(l => l.bpmIsValid).length;
                                                        // Calcular em quantos dias esta CPA aparece
                                                        const diasComCPA = new Set();
                                                        distribuicaoPorDia.forEach((dia, idx) => {
                                                            if (dia.some(loc => loc.cpa === cpa)) {
                                                                diasComCPA.add(idx);
                                                            }
                                                        });
                                                        return `
                                                            <tr>
                                                                <td>${cpa}</td>
                                                                <td><span class="badge bg-primary">${locs.length}</span></td>
                                                                <td><span class="badge ${comBPM > 0 ? 'bg-success' : 'bg-secondary'}">${comBPM}</span></td>
                                                                <td><span class="badge bg-info">${diasComCPA.size} dias</span></td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-building"></i> Top Municipios por Localidades</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Municipio</th>
                                                    <th>Localidades</th>
                                                    <th>Com BPM</th>
                                                    <th>CPAs</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(localidadesPorMunicipio)
                                                    .sort((a, b) => b[1].length - a[1].length)
                                                    .slice(0, 10)
                                                    .map(([municipio, locs]) => {
                                                        const comBPM = locs.filter(l => l.bpmIsValid).length;
                                                        const cpas = new Set(locs.map(l => l.cpa)).size;
                                                        return `
                                                            <tr>
                                                                <td>${municipio}</td>
                                                                <td><span class="badge bg-primary">${locs.length}</span></td>
                                                                <td><span class="badge ${comBPM > 0 ? 'bg-success' : 'bg-secondary'}">${comBPM}</span></td>
                                                                <td><span class="badge bg-info">${cpas}</span></td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

            document.getElementById('planning').innerHTML = planningHtml;
        }

        // PDF Generation Functions - PRESERVADA A ESTRUTURA ORIGINAL
        document.getElementById('exportPdfBtn').addEventListener('click', function() {
            generatePDF(true);
        });

        document.getElementById('previewPdfBtn').addEventListener('click', function() {
            generatePDF(false);
        });

        function generatePDF(download = true) {
            document.getElementById('loadingPdf').style.display = 'flex';
            
            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    // Criar PDF no formato LANDSCAPE (horizontal) para melhor visualizacao em tabelas
                    const doc = new jsPDF('l', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 10;
                    let yPos = margin;
                    const today = new Date();
                    
                    // ============================================
                    // PAGINA 1: CAPA E RESUMO EXECUTIVO
                    // ============================================
                    
                    // Header com gradiente simulado
                    doc.setFillColor(26, 95, 180);
                    doc.rect(0, 0, pageWidth, 35, 'F');
                    
                    // Titulo principal
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(22);
                    doc.setFont(undefined, 'bold');
                    doc.text('OPERACAO BARRICADA ZERO', pageWidth/2, 15, { align: 'center' });
                    
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'normal');
                    doc.text('Planejamento Operacional Otimizado', pageWidth/2, 23, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.text(`Gerado em: ${today.toLocaleDateString('pt-BR')} as ${today.toLocaleTimeString('pt-BR').slice(0,5)}`, pageWidth/2, 30, { align: 'center' });
                    
                    yPos = 45;
                    
                    if (allData.planningData) {
                        const { distribuicaoPorDia, localidadesPorCPA, localidadesPorMunicipio, semanas, weekdays, startDate, numWeeks } = allData.planningData;
                        const totalLocalidades = distribuicaoPorDia.flat().length;
                        const localidadesComBPMValido = distribuicaoPorDia.flat().filter(loc => loc.bpmIsValid).length;
                        
                        // Box de resumo executivo
                        doc.setFillColor(240, 247, 255);
                        doc.roundedRect(margin, yPos, pageWidth - 2*margin, 45, 3, 3, 'F');
                        
                        doc.setTextColor(26, 95, 180);
                        doc.setFontSize(14);
                        doc.setFont(undefined, 'bold');
                        doc.text('RESUMO EXECUTIVO', margin + 5, yPos + 10);
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        
                        const col1X = margin + 5;
                        const col2X = margin + 90;
                        const col3X = margin + 180;
                        
                        doc.text(`Periodo: ${formatDate(weekdays[0])} a ${formatDate(weekdays[weekdays.length - 1])}`, col1X, yPos + 20);
                        doc.text(`Total de Semanas: ${semanas}`, col1X, yPos + 27);
                        doc.text(`Dias Uteis: ${weekdays.length}`, col1X, yPos + 34);
                        
                        doc.text(`Total de Localidades: ${totalLocalidades}`, col2X, yPos + 20);
                        doc.text(`Com BPM Validado: ${localidadesComBPMValido} (${Math.round((localidadesComBPMValido/totalLocalidades)*100)}%)`, col2X, yPos + 27);
                        doc.text(`Sem BPM: ${totalLocalidades - localidadesComBPMValido}`, col2X, yPos + 34);
                        
                        doc.text(`CPAs Envolvidas: ${Object.keys(localidadesPorCPA).length}`, col3X, yPos + 20);
                        doc.text(`Municipios: ${Object.keys(localidadesPorMunicipio).length}`, col3X, yPos + 27);
                        
                        yPos = 100;
                        
                        // Tabela de resumo por CPA
                        doc.setTextColor(26, 95, 180);
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('DISTRIBUICAO POR CPA', margin, yPos);
                        yPos += 5;
                        
                        const topCPAs = Object.entries(localidadesPorCPA)
                            .sort((a, b) => b[1].length - a[1].length)
                            .slice(0, 15);
                        
                        doc.autoTable({
                            startY: yPos,
                            head: [['CPA', 'Localidades', 'Com BPM', 'Sem BPM', '% Cobertura']],
                            body: topCPAs.map(([cpa, locs]) => {
                                const comBPM = locs.filter(l => l.bpmIsValid).length;
                                const semBPM = locs.length - comBPM;
                                const cobertura = Math.round((comBPM / locs.length) * 100);
                                return [
                                    cpa.length > 35 ? cpa.substring(0, 32) + '...' : cpa,
                                    locs.length,
                                    comBPM,
                                    semBPM,
                                    cobertura + '%'
                                ];
                            }),
                            styles: { 
                                fontSize: 8,
                                cellPadding: 2
                            },
                            headStyles: { 
                                fillColor: [26, 95, 180],
                                textColor: [255, 255, 255],
                                fontStyle: 'bold'
                            },
                            alternateRowStyles: { fillColor: [248, 249, 250] },
                            margin: { left: margin, right: margin }
                        });
                        
                        // ============================================
                        // PAGINAS DE PLANEJAMENTO SEMANAL
                        // ============================================
                        
                        for (let week = 0; week < semanas; week++) {
                            doc.addPage('l', 'a4');
                            
                            const weekStart = week * 5;
                            const weekDates = weekdays.slice(weekStart, weekStart + 5);
                            const semanaNum = week + 1;
                            
                            // Header da pagina
                            doc.setFillColor(26, 95, 180);
                            doc.rect(0, 0, pageWidth, 20, 'F');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(14);
                            doc.setFont(undefined, 'bold');
                            doc.text(`SEMANA ${semanaNum} - ${formatDate(weekDates[0])} a ${formatDate(weekDates[weekDates.length - 1])}`, pageWidth/2, 12, { align: 'center' });
                            
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'normal');
                            doc.text(`Pagina ${doc.internal.getNumberOfPages()} | Operacao Barricada Zero`, pageWidth - margin, 15, { align: 'right' });
                            
                            yPos = 25;
                            
                            // Criar tabela horizontal com 5 colunas (dias da semana)
                            const diasNomes = ['SEG', 'TER', 'QUA', 'QUI', 'SEX'];
                            const colWidth = (pageWidth - 2*margin) / 5;
                            
                            // Cabecalho dos dias
                            doc.setFillColor(38, 162, 105);
                            doc.rect(margin, yPos, pageWidth - 2*margin, 12, 'F');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            
                            for (let d = 0; d < 5; d++) {
                                if (weekDates[d]) {
                                    const colX = margin + (d * colWidth);
                                    doc.text(`${diasNomes[d]} - ${formatDateShort(weekDates[d])}`, colX + colWidth/2, yPos + 8, { align: 'center' });
                                }
                            }
                            
                            yPos += 15;
                            
                            // Conteudo das colunas - usando a nova distribuição
                            const cpasDaSemana = new Set();
                            for (let d = 0; d < 5; d++) {
                                const diaGlobalIndex = week * 5 + d;
                                const localidadesDoDia = distribuicaoPorDia[diaGlobalIndex] || [];
                                localidadesDoDia.forEach(loc => {
                                    cpasDaSemana.add(loc.cpa);
                                });
                            }
                            
                            // Mostrar top CPAs em tabela detalhada
                            const maxCPAsPerPage = 8;
                            const cpasParaMostrar = Array.from(cpasDaSemana)
                                .sort((a, b) => localidadesPorCPA[b].length - localidadesPorCPA[a].length)
                                .slice(0, maxCPAsPerPage);
                            
                            // Preparar dados para autoTable
                            const tableData = [];
                            
                            cpasParaMostrar.forEach(cpa => {
                                const cpaNome = cpa.length > 25 ? cpa.substring(0, 22) + '...' : cpa;
                                
                                // Criar linha com localidades
                                const row = [cpaNome];
                                
                                // Adicionar localidades para cada dia
                                for (let d = 0; d < 5; d++) {
                                    if (weekDates[d]) {
                                        const diaGlobalIndex = week * 5 + d;
                                        const localidadesDoDia = distribuicaoPorDia[diaGlobalIndex] || [];
                                        const localidadesCPA = localidadesDoDia.filter(loc => loc.cpa === cpa);
                                        
                                        const locTexts = localidadesCPA.map(loc => {
                                            const nome = loc.localidadeNome.length > 15 ? loc.localidadeNome.substring(0, 12) + '...' : loc.localidadeNome;
                                            const bpmStatus = loc.bpmIsValid ? '[OK]' : '[!]';
                                            return `${nome} ${bpmStatus} ${loc.data.rem}r`;
                                        });
                                        row.push(locTexts.join('\n') || '-');
                                    } else {
                                        row.push('-');
                                    }
                                }
                                
                                tableData.push(row);
                            });
                            
                            // Gerar tabela
                            doc.autoTable({
                                startY: yPos,
                                head: [['CPA / Localidades', diasNomes[0], diasNomes[1], diasNomes[2], diasNomes[3], diasNomes[4]]],
                                body: tableData,
                                styles: { 
                                    fontSize: 7,
                                    cellPadding: 2,
                                    overflow: 'linebreak',
                                    valign: 'top'
                                },
                                headStyles: { 
                                    fillColor: [26, 95, 180],
                                    textColor: [255, 255, 255],
                                    fontStyle: 'bold',
                                    fontSize: 8
                                },
                                columnStyles: {
                                    0: { cellWidth: 50, fontStyle: 'bold', fillColor: [240, 247, 255] },
                                    1: { cellWidth: 'auto' },
                                    2: { cellWidth: 'auto' },
                                    3: { cellWidth: 'auto' },
                                    4: { cellWidth: 'auto' },
                                    5: { cellWidth: 'auto' }
                                },
                                alternateRowStyles: { fillColor: [248, 249, 250] },
                                margin: { left: margin, right: margin }
                            });
                            
                            // Legenda na parte inferior
                            const finalY = doc.lastAutoTable.finalY + 5;
                            doc.setFontSize(7);
                            doc.setTextColor(100, 100, 100);
                            doc.text('[OK] = BPM Validado | [!] = Sem BPM | r = remocoes', margin, finalY);
                            
                            if (cpasDaSemana.size > maxCPAsPerPage) {
                                doc.text(`+ ${cpasDaSemana.size - maxCPAsPerPage} CPAs adicionais nao exibidas`, margin, finalY + 4);
                            }
                        }
                        
                        // ============================================
                        // PAGINA FINAL: LISTA COMPLETA DE LOCALIDADES
                        // ============================================
                        
                        doc.addPage('l', 'a4');
                        
                        // Header
                        doc.setFillColor(26, 95, 180);
                        doc.rect(0, 0, pageWidth, 20, 'F');
                        
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(14);
                        doc.setFont(undefined, 'bold');
                        doc.text('LISTA COMPLETA DE LOCALIDADES', pageWidth/2, 12, { align: 'center' });
                        
                        yPos = 25;
                        
                        // Preparar dados de todas localidades
                        const allLocsData = distribuicaoPorDia.flat()
                            .sort((a, b) => b.data.rem - a.data.rem)
                            .slice(0, 50)
                            .map((loc, idx) => [
                                idx + 1,
                                loc.localidadeNome.length > 25 ? loc.localidadeNome.substring(0, 22) + '...' : loc.localidadeNome,
                                loc.municipio.length > 20 ? loc.municipio.substring(0, 17) + '...' : loc.municipio,
                                loc.cpa.length > 20 ? loc.cpa.substring(0, 17) + '...' : loc.cpa,
                                loc.bpmIsValid ? loc.bpm.substring(0, 15) : 'N/I',
                                loc.data.rem,
                                loc.data.peso.toFixed(1),
                                loc.intensityLevel,
                                loc.bpmIsValid ? 'SIM' : 'NAO'
                            ]);
                        
                        doc.autoTable({
                            startY: yPos,
                            head: [['#', 'Localidade', 'Municipio', 'CPA', 'BPM', 'Rem', 'Peso', 'Intens.', 'Valid']],
                            body: allLocsData,
                            styles: { 
                                fontSize: 7,
                                cellPadding: 2
                            },
                            headStyles: { 
                                fillColor: [26, 95, 180],
                                textColor: [255, 255, 255],
                                fontStyle: 'bold'
                            },
                            columnStyles: {
                                0: { cellWidth: 8 },
                                1: { cellWidth: 45 },
                                2: { cellWidth: 35 },
                                3: { cellWidth: 35 },
                                4: { cellWidth: 30 },
                                5: { cellWidth: 15, halign: 'center' },
                                6: { cellWidth: 15, halign: 'center' },
                                7: { cellWidth: 20, halign: 'center' },
                                8: { cellWidth: 15, halign: 'center' }
                            },
                            alternateRowStyles: { fillColor: [248, 249, 250] },
                            margin: { left: margin, right: margin },
                            didParseCell: function(data) {
                                // Colorir celulas de intensidade
                                if (data.column.index === 7 && data.section === 'body') {
                                    if (data.cell.raw === 'ALTA') {
                                        data.cell.styles.textColor = [224, 27, 36];
                                        data.cell.styles.fontStyle = 'bold';
                                    } else if (data.cell.raw === 'MEDIA') {
                                        data.cell.styles.textColor = [229, 165, 10];
                                    }
                                }
                                // Colorir celulas de validacao
                                if (data.column.index === 8 && data.section === 'body') {
                                    if (data.cell.raw === 'SIM') {
                                        data.cell.styles.textColor = [38, 162, 105];
                                        data.cell.styles.fontStyle = 'bold';
                                    } else {
                                        data.cell.styles.textColor = [229, 165, 10];
                                    }
                                }
                            }
                        });
                        
                        // Nota de rodape
                        const finalY2 = doc.lastAutoTable.finalY + 5;
                        doc.setFontSize(7);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Exibindo as ${Math.min(50, distribuicaoPorDia.flat().length)} localidades com maior numero de remocoes.`, margin, finalY2);
                        if (distribuicaoPorDia.flat().length > 50) {
                            doc.text(`Total de ${distribuicaoPorDia.flat().length} localidades no planejamento.`, margin, finalY2 + 4);
                        }
                    }
                    
                    // Footer em todas as paginas
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.setFontSize(7);
                        doc.setTextColor(150, 150, 150);
                        doc.text(`Pagina ${i} de ${totalPages}`, pageWidth/2, pageHeight - 5, { align: 'center' });
                    }
                    
                    // Salvar ou visualizar
                    if (download) {
                        const fileName = `Planejamento_Barricada_Zero_${today.toISOString().slice(0,10)}.pdf`;
                        doc.save(fileName);
                    } else {
                        const pdfBlob = doc.output('blob');
                        const url = URL.createObjectURL(pdfBlob);
                        window.open(url, '_blank');
                    }
                    
                } catch (error) {
                    console.error('Erro ao gerar PDF:', error);
                    alert('Erro ao gerar PDF. Por favor, verifique o console para detalhes.');
                } finally {
                    document.getElementById('loadingPdf').style.display = 'none';
                }
            }, 100);
        }
    </script>
</body>
</html>