<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise da Operação Barricada Zero</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <!-- SheetJS CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #1a5fb4;
            --secondary-color: #26a269;
            --accent-color: #e5a50a;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', system-ui, sans-serif;
            padding-top: 20px;
            padding-bottom: 40px;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--primary-color), #0d47a1);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }
        
        .card-custom {
            border: none;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-custom:hover {
            transform: translateY(-5px);
        }
        
        .card-header-custom {
            background-color: var(--primary-color);
            color: white;
            border-bottom: none;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .stat-card {
            background: white;
            border-left: 5px solid var(--primary-color);
            padding: 15px;
            height: 100%;
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-card .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .priority-high {
            border-left-color: #e01b24 !important;
        }
        
        .priority-medium {
            border-left-color: var(--accent-color) !important;
        }
        
        .priority-low {
            border-left-color: #26a269 !important;
        }
        
        .table-custom {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table-custom thead th {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 15px;
        }
        
        .table-custom tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .btn-custom {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            background-color: #0d47a1;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .insight-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 5px solid var(--accent-color);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .chart-container-pie {
            position: relative;
            height: 280px;
            width: 100%;
            margin: 0 auto;
        }
        
        .action-plan-day {
            background-color: #f0f7ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .file-input-area {
            border: 2px dashed #ced4da;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .file-input-area:hover {
            border-color: var(--primary-color);
            background-color: #e9f2ff;
        }
        
        #loadingPdf {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
        
        .planning-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .planning-table th {
            background-color: #1a5fb4;
            color: white;
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .planning-table td {
            padding: 8px;
            border: 1px solid #ddd;
            vertical-align: top;
        }
        
        .planning-table .week-cell {
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: center;
        }
        
        .planning-table .day-cell {
            background-color: #f0f7ff;
            position: relative;
        }
        
        .validated-bpm {
            color: #26a269;
            font-weight: bold;
        }
        
        .unvalidated-bpm {
            color: #666;
            font-style: italic;
        }
        
        .bpm-badge {
            font-size: 0.75em;
            padding: 2px 6px;
            margin-right: 3px;
            margin-bottom: 3px;
            display: inline-block;
        }
        
        .localidade-bpm-info {
            font-size: 0.85em;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 4px 8px;
            margin-top: 4px;
            border-left: 3px solid #1a5fb4;
        }
        
        .insights-container {
            margin-top: 15px;
        }
        
        .cpa-municipio-group {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #1a5fb4;
        }
        
        .coverage-badge {
            font-size: 0.8em;
            padding: 3px 8px;
            margin-left: 5px;
        }
        
        .day-localidades-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .localidade-item {
            background-color: white;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #26a269;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .localidade-item-header {
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .localidade-item-details {
            font-size: 0.75em;
            color: #666;
        }
        
        .localidade-item-badges {
            margin-top: 4px;
        }
        
        .localidade-item .badge {
            font-size: 0.7em;
            padding: 2px 5px;
            margin-right: 2px;
            margin-bottom: 2px;
        }
        
        .day-summary {
            background-color: #e9f7ff;
            border-radius: 4px;
            padding: 4px 8px;
            margin-top: 8px;
            font-size: 0.75em;
            border-left: 3px solid #1a5fb4;
        }
        
        .day-total-badge {
            background-color: #1a5fb4;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .compact-localidade {
            padding: 4px 6px;
            margin-bottom: 4px;
            border-radius: 4px;
            background-color: white;
            border-left: 2px solid #1a5fb4;
            font-size: 0.8em;
        }
        
        .compact-localidade-header {
            font-weight: bold;
            font-size: 0.85em;
            margin-bottom: 1px;
        }
        
        .compact-localidade-details {
            font-size: 0.7em;
            color: #666;
        }
        
        .compact-badge {
            font-size: 0.65em;
            padding: 1px 4px;
            margin-right: 2px;
        }
        
        .scrollable-localidades {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .scrollable-localidades::-webkit-scrollbar {
            width: 6px;
        }
        
        .scrollable-localidades::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .scrollable-localidades::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .scrollable-localidades::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        .day-header {
            background-color: #e9f7ff;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #1a5fb4;
        }
        
        .localidade-table {
            width: 100%;
            font-size: 0.8em;
            margin-bottom: 10px;
        }
        
        .localidade-table th {
            background-color: #f8f9fa;
            padding: 4px;
            font-size: 0.75em;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .localidade-table td {
            padding: 4px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .localidade-table tr:last-child td {
            border-bottom: none;
        }
        
        .cpa-group {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #26a269;
        }
        
        .cpa-group-header {
            font-weight: bold;
            color: #1a5fb4;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .week-card {
            margin-bottom: 25px;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .week-card-header {
            background-color: #1a5fb4;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
        }
        
        .day-column {
            padding: 10px;
            border-right: 1px solid #eee;
            min-height: 500px;
        }
        
        .day-column:last-child {
            border-right: none;
        }

        .horizontal-planning-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            margin-bottom: 20px;
        }

        .horizontal-planning-table th {
            background: linear-gradient(135deg, #1a5fb4, #0d47a1);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85em;
            border: 1px solid #0d47a1;
            width: 14.28%;
        }

        .horizontal-planning-table td {
            vertical-align: top;
            padding: 8px;
            border: 1px solid #dee2e6;
            background-color: #fff;
            font-size: 0.75em;
        }

        .horizontal-planning-table .day-date {
            font-size: 0.7em;
            color: rgba(255,255,255,0.9);
            font-weight: normal;
        }

        .loc-card {
            background: linear-gradient(to bottom, #f8f9fa, #fff);
            border-radius: 4px;
            padding: 6px;
            margin-bottom: 6px;
            border-left: 3px solid #26a269;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .loc-card.no-bpm {
            border-left-color: #e5a50a;
        }

        .loc-card-name {
            font-weight: 600;
            font-size: 0.8em;
            color: #212529;
            margin-bottom: 2px;
        }

        .loc-card-details {
            font-size: 0.7em;
            color: #6c757d;
        }

        .loc-card-badges {
            margin-top: 4px;
        }

        .loc-card-badges .badge {
            font-size: 0.65em;
            padding: 2px 5px;
            margin-right: 2px;
        }

        .week-summary-row td {
            background-color: #e9f7ff;
            font-weight: 600;
            text-align: center;
            padding: 6px;
            font-size: 0.75em;
        }
        
        /* Estilo para insights preditivos */
        .insight-item {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 6px;
            background-color: #f8f9fa;
            border-left: 4px solid #1a5fb4;
        }
        
        .insight-item.predictive {
            border-left-color: #e5a50a;
            background-color: #fff8e1;
        }
        
        .insight-item.prescriptive {
            border-left-color: #26a269;
            background-color: #e8f5e9;
        }
        
        .insight-icon {
            font-size: 1.2em;
            margin-right: 8px;
        }
        
        .insight-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }
        
        .insight-desc {
            font-size: 0.9em;
            color: #666;
        }
        
        /* Estilo para botões de visualização no planejamento */
        .view-details-btn {
            background-color: #1a5fb4;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8em;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .view-details-btn:hover {
            background-color: #0d47a1;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .view-details-btn i {
            margin-right: 5px;
        }
        
        /* Modal para visualização de detalhes */
        .planning-modal {
            max-width: 90%;
            width: 90%;
        }
        
        .modal-localidade-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #26a269;
        }
        
        /* Ajuste para centralizar o gráfico de pizza */
        .pie-chart-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        
        /* Botões de exportação nos modais */
        .modal-export-btn {
            background-color: #e01b24;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
        }
        
        .modal-export-btn:hover {
            background-color: #c01019;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .modal-export-btn i {
            margin-right: 6px;
        }
        
        /* Loading específico para modais */
        .modal-loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        /* Classe para ocultar elementos */
        .btn-hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingPdf">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <h4>Gerando PDF...</h4>
        <p>Aguarde um momento</p>
    </div>
    
    <!-- Modal para visualização de detalhes do planejamento -->
    <div class="modal fade" id="planningDetailModal" tabindex="-1" aria-labelledby="planningDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl planning-modal">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="planningDetailModalLabel">Detalhes do Planejamento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body position-relative" id="planningDetailContent">
                    <!-- Conteúdo será preenchido dinamicamente -->
                    <!-- Loading para geração de PDF do modal -->
                    <div class="modal-loading" id="modalLoadingPdf">
                        <div class="spinner-border text-primary mb-3" style="width: 2rem; height: 2rem;"></div>
                        <h5>Gerando PDF...</h5>
                        <p>Preparando documento para download</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="exportModalPdfBtn">
                        <i class="bi bi-file-pdf"></i> Exportar para PDF
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="fullContent">
        <!-- Header Section -->
        <div class="header-section">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-shield-check"></i> Operação Barricada Zero</h1>
                    <p class="lead">Análise de dados para planejamento operacional na remoção de barricadas</p>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="card card-custom mb-4">
            <div class="card-header card-header-custom">
                <h5 class="mb-0"><i class="bi bi-upload"></i> Importar Dados</h5>
            </div>
            <div class="card-body">
                <div class="file-input-area mb-3">
                    <i class="bi bi-file-earmark-excel fs-1 text-primary mb-3"></i>
                    <h5>Arraste e solte seu arquivo Excel aqui</h5>
                    <p class="text-muted">ou clique no botão abaixo para selecionar</p>
                    <input type="file" id="fileInput" class="form-control d-none" accept=".xlsx">
                    <button id="selectFileBtn" class="btn btn-custom mt-2">
                        <i class="bi bi-folder2-open"></i> Selecionar Arquivo
                    </button>
                    <div id="fileName" class="mt-3 fw-bold"></div>
                </div>
                <button id="analyzeBtn" class="btn btn-custom w-100">
                    <i class="bi bi-graph-up"></i> Analisar Dados
                </button>
            </div>
        </div>

        <!-- Analysis Results Section -->
        <div id="analysis" class="row"></div>

        <!-- Charts Section -->
        <div id="charts" class="row"></div>

        <!-- Planning Section -->
        <div id="planningSection" style="display: none;">
            <div class="card card-custom mb-4">
                <div class="card-header card-header-custom">
                    <h5 class="mb-0"><i class="bi bi-calendar-week"></i> Planejamento de Ações Futuras</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="startDateInput" class="form-label fw-bold">
                                <i class="bi bi-calendar-date"></i> Data de Início das Próximas Ações:
                            </label>
                            <input type="date" id="startDateInput" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label for="weeksInput" class="form-label fw-bold">
                                <i class="bi bi-calendar-week"></i> Número de Semanas:
                            </label>
                            <select id="weeksInput" class="form-select">
                                <option value="1">1 semana</option>
                                <option value="2">2 semanas</option>
                                <option value="3">3 semanas</option>
                                <option value="4" selected>4 semanas</option>
                                <option value="5">5 semanas</option>
                                <option value="6">6 semanas</option>
                                <option value="7">7 semanas</option>
                                <option value="8">8 semanas</option>
                            </select>
                        </div>
                    </div>
                    <button id="generatePlanningBtn" class="btn btn-custom">
                        <i class="bi bi-calendar-plus"></i> Gerar Planejamento
                    </button>
                </div>
            </div>
            <div id="planning" class="row"></div>
        </div>

        <!-- PDF Export Section -->
        <div id="pdfSection" class="text-center mt-5" style="display: none;">
            <div class="card card-custom">
                <div class="card-body">
                    <h4 class="card-title"><i class="bi bi-file-pdf"></i> Exportar Relatório</h4>
                    <p class="text-muted">Gere um relatório PDF estruturado com todas as análises e planejamentos</p>
                    <button id="exportPdfBtn" class="btn btn-custom btn-lg">
                        <i class="bi bi-download"></i> Gerar e Baixar PDF
                    </button>
                    <button id="previewPdfBtn" class="btn btn-outline-primary btn-lg ms-2">
                        <i class="bi bi-eye"></i> Visualizar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurar data padrão
        document.getElementById('startDateInput').value = '2026-01-06';

        // Objeto para armazenar todos os dados
        let allData = {
            sortedMunicipios: [],
            sortedLocalidades: [],
            recentByMunicipio: {},
            recentByLocalidade: {},
            totalRem: 0,
            totalVias: 0,
            totalPeso: 0,
            avgPesoPerRem: 0,
            filteredData: [],
            maxDate: null,
            planningData: null,
            bpmValidationData: {},
            advancedInsights: []
        };

        // Variáveis para controle dos modais
        let currentModalType = null;
        let currentModalData = null;

        // Função para ocultar o botão de análise
        function hideAnalyzeButton() {
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzeBtn) {
                analyzeBtn.classList.add('btn-hidden');
            }
        }

        // Configurar event listeners quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners para elementos estáticos
            document.getElementById('selectFileBtn').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name || 'Nenhum arquivo selecionado';
                document.getElementById('fileName').textContent = `Arquivo: ${fileName}`;
            });

            document.getElementById('analyzeBtn').addEventListener('click', function() {
                const fileInput = document.getElementById('fileInput');
                if (!fileInput.files.length) {
                    alert('Por favor, selecione um arquivo Excel.');
                    return;
                }
                
                // Desabilitar o botão durante a análise
                this.disabled = true;
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i> Analisando...';
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'array' });
                    processWorkbook(workbook);
                    
                    // Restaurar estado do botão
                    document.getElementById('analyzeBtn').innerHTML = originalText;
                    document.getElementById('analyzeBtn').disabled = false;
                };
                
                reader.onerror = function() {
                    alert('Erro ao ler o arquivo.');
                    document.getElementById('analyzeBtn').innerHTML = originalText;
                    document.getElementById('analyzeBtn').disabled = false;
                };
                
                reader.readAsArrayBuffer(file);
            });

            document.getElementById('generatePlanningBtn').addEventListener('click', generatePlanning);
            document.getElementById('exportPdfBtn').addEventListener('click', function() {
                generatePDF(true);
            });
            document.getElementById('previewPdfBtn').addEventListener('click', function() {
                generatePDF(false);
            });

            // Configurar event listener para o botão de exportação do modal
            document.getElementById('exportModalPdfBtn').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                exportModalToPDF();
            });

            // Event delegation para botões dinâmicos
            document.addEventListener('click', function(e) {
                // Verificar se o clique foi em um botão de visualização de semana
                if (e.target && e.target.classList.contains('view-week-details')) {
                    const weekNum = parseInt(e.target.getAttribute('data-week'));
                    showWeekDetails(weekNum);
                    return;
                }
                
                // Verificar se o clique foi em um botão de visualização de dia
                if (e.target && e.target.classList.contains('view-day-details')) {
                    const weekNum = parseInt(e.target.getAttribute('data-week'));
                    const dayNum = parseInt(e.target.getAttribute('data-day'));
                    const dateStr = e.target.getAttribute('data-date');
                    showDayDetails(weekNum, dayNum, dateStr);
                    return;
                }
                
                // Verificar se o clique foi em um botão de resumo de CPA
                if (e.target && e.target.classList.contains('view-cpa-summary')) {
                    showCPASummary();
                    return;
                }
                
                // Verificar se o clique foi em um botão de resumo de município
                if (e.target && e.target.classList.contains('view-municipio-summary')) {
                    showMunicipioSummary();
                    return;
                }
            });
        });

        // Funções auxiliares
        // FUNÇÃO CORRIGIDA: Converter data do Excel para JavaScript (corrigido problema de fuso horário)
        function excelDateToJSDateSimple(serial) {
            // Excel usa uma base de 31/12/1899 (mas na verdade é 30/12/1899)
            // Ajuste para o bug do Excel (trata 1900 como ano bissexto)
            let adjustedSerial = serial;
            if (serial >= 60) {
                adjustedSerial = serial + 0.5;
            }
            
            // Cálculo direto sem problemas de fuso horário
            // Excel: 0 = 00/01/1900, 1 = 01/01/1900, etc.
            // JavaScript: 0 = 01/01/1970
            const excelEpoch = new Date(1899, 11, 30); // 30/12/1899
            const msPerDay = 86400000;
            
            // Cria a data corretamente
            const date = new Date(excelEpoch.getTime() + (adjustedSerial * msPerDay));
            
            // Ajuste para compensar qualquer diferença de fuso horário
            // Forçamos a data para o meio-dia local para evitar problemas
            date.setHours(12, 0, 0, 0);
            
            return date;
        }

        function formatDate(date) {
            if (!(date instanceof Date) || isNaN(date)) return 'Data inválida';
            
            // Formata a data local sem problemas de fuso horário
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            
            return `${day}/${month}/${year}`;
        }

        function formatDateShort(date) {
            if (!(date instanceof Date) || isNaN(date)) return '--/--';
            
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            
            return `${day}/${month}`;
        }

        function isWeekday(date) {
            const day = date.getDay();
            return day >= 1 && day <= 5;
        }

        function getNextWeekdays(startDate, numWeeks = 4) {
            const dates = [];
            let current = new Date(startDate);
            
            current.setHours(12, 0, 0, 0);
            
            while (dates.length < numWeeks * 5) {
                if (isWeekday(current)) {
                    dates.push(new Date(current));
                }
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }

        function getDayName(dayIndex) {
            const days = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex'];
            return days[dayIndex] || '';
        }

        function getDayNameFull(dayIndex) {
            const days = ['Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira'];
            return days[dayIndex] || '';
        }

        function normalizeText(text) {
            if (!text) return '';
            return text.toString()
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^\w\s]/gi, '')
                .trim();
        }

        function isBPMValidForLocalidade(bpmName, localidadeNome, bairro, municipioNome, bpmValidationData) {
            if (!bpmName || bpmName === 'Não informado' || (!localidadeNome && !bairro)) {
                return false;
            }
            
            const normalizedBPM = normalizeText(bpmName);
            const normalizedLocalidade = localidadeNome ? normalizeText(localidadeNome) : '';
            const normalizedBairro = bairro ? normalizeText(bairro) : '';
            const normalizedMunicipio = municipioNome ? normalizeText(municipioNome) : '';
            
            if (!bpmValidationData[normalizedBPM]) {
                return false;
            }
            
            const areasAtuacao = bpmValidationData[normalizedBPM].areas || new Set();
            
            const termosParaVerificar = [];
            if (normalizedLocalidade) termosParaVerificar.push(normalizedLocalidade);
            if (normalizedBairro) termosParaVerificar.push(normalizedBairro);
            if (normalizedMunicipio) termosParaVerificar.push(normalizedMunicipio);
            
            for (const termo of termosParaVerificar) {
                for (const area of areasAtuacao) {
                    if (area.includes(termo) || termo.includes(area)) {
                        return true;
                    }
                }
            }
            
            return false;
        }
        
        // Gerar insights preditivos e prescritivos
        function generateAdvancedInsights(data) {
            const insights = [];
            
            // Insight baseado na média de peso por remoção
            if (data.avgPesoPerRem > 15) {
                insights.push({
                    type: 'predictive',
                    title: 'Alerta de Barricadas Pesadas',
                    description: `A média de ${data.avgPesoPerRem.toFixed(2)} toneladas por remoção indica presença de barricadas robustas. Planeje equipes e equipamentos adequados para manuseio de cargas pesadas.`,
                    icon: 'bi-exclamation-triangle'
                });
            } else if (data.avgPesoPerRem > 8) {
                insights.push({
                    type: 'predictive',
                    title: 'Barricadas de Porte Moderado',
                    description: `Média de ${data.avgPesoPerRem.toFixed(2)} toneladas sugere barricadas de tamanho médio. Equipes padrão são suficientes, mas considere reforço para locais críticos.`,
                    icon: 'bi-speedometer2'
                });
            } else {
                insights.push({
                    type: 'predictive',
                    title: 'Barricadas Leves Predominantes',
                    description: `Média de ${data.avgPesoPerRem.toFixed(2)} toneladas indica barricadas menores. Operações podem ser mais ágeis com menor necessidade de equipamentos pesados.`,
                    icon: 'bi-check-circle'
                });
            }
            
            // Insight baseado na distribuição temporal
            if (data.filteredData.length > 0) {
                const dates = data.filteredData.map(row => row.DATA);
                const recentDate = new Date(Math.max(...dates));
                const now = new Date();
                const daysSinceLast = Math.floor((now - recentDate) / (1000 * 60 * 60 * 24));
                
                if (daysSinceLast > 30) {
                    insights.push({
                        type: 'predictive',
                        title: 'Possível Acúmulo Recente',
                        description: `Última operação registrada há ${daysSinceLast} dias. Pode haver acúmulo significativo de barricadas desde então. Priorize áreas com histórico de recorrência rápida.`,
                        icon: 'bi-clock-history'
                    });
                }
            }
            
            // Insight baseado no top municípios
            if (data.sortedMunicipios.length > 0) {
                const topMun = data.sortedMunicipios[0];
                insights.push({
                    type: 'prescriptive',
                    title: 'Foco Estratégico Recomendado',
                    description: `${topMun.MUNICIPIO} lidera com ${topMun.REMOCOES} remoções. Recomenda-se alocar 30% dos recursos para este município, com atenção especial para áreas periféricas.`,
                    icon: 'bi-geo-alt'
                });
            }
            
            // Insight baseado na eficiência
            const efficiency = data.totalVias / (data.totalRem || 1);
            if (efficiency > 1.5) {
                insights.push({
                    type: 'prescriptive',
                    title: 'Alta Eficiência de Vias Liberadas',
                    description: `Relação de ${efficiency.toFixed(2)} vias por remoção. Mantenha a estratégia atual e replique para outras regiões.`,
                    icon: 'bi-graph-up-arrow'
                });
            } else if (efficiency < 0.8) {
                insights.push({
                    type: 'prescriptive',
                    title: 'Oportunidade de Otimização',
                    description: `Relação de ${efficiency.toFixed(2)} vias por remoção. Considere estratégias de remoção em bloco para liberar mais vias por operação.`,
                    icon: 'bi-tools'
                });
            }
            
            // Insight baseado na sazonalidade
            const currentMonth = new Date().getMonth();
            if (currentMonth >= 10 || currentMonth <= 2) {
                insights.push({
                    type: 'predictive',
                    title: 'Período de Alta Ocorrência',
                    description: 'Estamos no período de fim/começo de ano, historicamente com maior incidência de barricadas. Aumente patrulhamento preventivo em 25%.',
                    icon: 'bi-calendar-event'
                });
            }
            
            // Insight baseado na distribuição geográfica
            if (data.sortedMunicipios.length >= 5) {
                const top5Total = data.sortedMunicipios.slice(0, 5).reduce((sum, mun) => sum + mun.REMOCOES, 0);
                const percentageTop5 = (top5Total / data.totalRem) * 100;
                
                if (percentageTop5 > 70) {
                    insights.push({
                        type: 'prescriptive',
                        title: 'Concentração Geográfica Alta',
                        description: `Os 5 principais municípios concentram ${percentageTop5.toFixed(1)}% das remoções. Foque recursos nestas regiões para impacto máximo.`,
                        icon: 'bi-pie-chart'
                    });
                }
            }
            
            return insights;
        }

        // Processar arquivo Excel
        function processWorkbook(workbook) {
            try {
                // 1. Processar a aba CPA x BTL
                const cpaBtlSheet = workbook.Sheets['CPA x BTL'];
                if (cpaBtlSheet) {
                    const cpaBtlData = XLSX.utils.sheet_to_json(cpaBtlSheet, { 
                        header: 1,
                        defval: ''
                    });
                    
                    allData.bpmValidationData = {};
                    
                    let bpmColumnIndex = -1;
                    let areasAtuacaoColumnIndex = -1;
                    
                    if (cpaBtlData.length > 0) {
                        const headerRow = cpaBtlData[0];
                        
                        for (let i = 0; i < headerRow.length; i++) {
                            const cellValue = headerRow[i].toString().toLowerCase();
                            if (cellValue.includes('bpm') || cellValue.includes('batalhao') || cellValue.includes('batalhão')) {
                                bpmColumnIndex = i;
                            }
                            if (cellValue.includes('município') || cellValue.includes('municipio') || 
                                cellValue.includes('atuacao') || cellValue.includes('atuação') ||
                                cellValue.includes('bairro') || cellValue.includes('localidade') ||
                                cellValue.includes('area') || cellValue.includes('área')) {
                                areasAtuacaoColumnIndex = i;
                            }
                        }
                        
                        if (bpmColumnIndex !== -1 && areasAtuacaoColumnIndex !== -1) {
                            for (let row = 1; row < cpaBtlData.length; row++) {
                                const bpmName = cpaBtlData[row][bpmColumnIndex];
                                const areasAtuacao = cpaBtlData[row][areasAtuacaoColumnIndex];
                                
                                if (bpmName && areasAtuacao) {
                                    const normalizedBPM = normalizeText(bpmName);
                                    
                                    if (!allData.bpmValidationData[normalizedBPM]) {
                                        allData.bpmValidationData[normalizedBPM] = {
                                            originalName: bpmName,
                                            areas: new Set()
                                        };
                                    }
                                    
                                    const areasList = areasAtuacao.toString()
                                        .split(/[,;]/)
                                        .map(area => normalizeText(area.trim()))
                                        .filter(area => area.length > 0);
                                    
                                    areasList.forEach(area => {
                                        allData.bpmValidationData[normalizedBPM].areas.add(area);
                                    });
                                }
                            }
                        }
                    }
                }

                // 2. Processar a aba GLOBAL
                const globalSheet = workbook.Sheets['GLOBAL'];
                if (!globalSheet) {
                    alert('Aba GLOBAL não encontrada.');
                    throw new Error('Aba GLOBAL não encontrada');
                }

                const globalData = XLSX.utils.sheet_to_json(globalSheet, { 
                    header: ['DATA', 'AREA', 'MUNICIPIO', 'BAIRRO', 'LOCALIDADE', 'REMOCOES', 'VIAS', 'PESO_TON', 'CPA', 'CMTE', 'BPM'], 
                    skipHeader: true 
                });
                
                allData.filteredData = globalData.filter(row => row.DATA && row.REMOCOES > 0);

                allData.filteredData.forEach(row => {
                    try {
                        // CORREÇÃO PRINCIPAL: Processamento de datas corrigido
                        if (typeof row.DATA === 'number') {
                            // Se for número do Excel, converte
                            row.DATA = excelDateToJSDateSimple(row.DATA);
                        } else if (row.DATA instanceof Date) {
                            // Já é uma data, garante que está no fuso correto
                            row.DATA.setHours(12, 0, 0, 0);
                        } else {
                            // Tenta parsear como string
                            const parsedDate = new Date(row.DATA);
                            if (!isNaN(parsedDate)) {
                                parsedDate.setHours(12, 0, 0, 0);
                                row.DATA = parsedDate;
                            } else {
                                // Data padrão se não conseguir parsear
                                const today = new Date();
                                today.setHours(12, 0, 0, 0);
                                row.DATA = today;
                            }
                        }
                        
                        // Garante que é uma data válida
                        if (!(row.DATA instanceof Date) || isNaN(row.DATA.getTime())) {
                            const today = new Date();
                            today.setHours(12, 0, 0, 0);
                            row.DATA = today;
                        }
                        
                        row.FORMATTED_DATA = formatDate(row.DATA);
                        row.REMOCOES = parseFloat(row.REMOCOES) || 0;
                        row.VIAS = parseFloat(row.VIAS) || 0;
                        row.PESO_TON = parseFloat(row.PESO_TON) || 0;
                        row.CPA = row.CPA || 'Não informado';
                        row.BPM = row.BPM || 'Não informado';
                        
                        row.LOCALIDADE_ID = row.LOCALIDADE || row.BAIRRO || 'Área não especificada';
                        row.LOCALIDADE_FULL = `${row.MUNICIPIO || 'Desconhecido'} / ${row.LOCALIDADE_ID}`;
                        
                        row.NORMALIZED_LOCALIDADE = normalizeText(row.LOCALIDADE_ID);
                        row.NORMALIZED_BAIRRO = normalizeText(row.BAIRRO);
                        row.NORMALIZED_MUNICIPIO = normalizeText(row.MUNICIPIO);
                        row.NORMALIZED_BPM = normalizeText(row.BPM);
                    } catch (error) {
                        console.error('Erro ao processar linha:', error);
                    }
                });

                // Calcula a data máxima
                allData.maxDate = allData.filteredData.reduce((max, row) => row.DATA > max ? row.DATA : max, new Date(0));

                // Agrupa por localidade e município, mantendo o mais recente
                allData.filteredData.forEach(row => {
                    const locKey = row.NORMALIZED_LOCALIDADE + '_' + row.NORMALIZED_MUNICIPIO;
                    if (!allData.recentByLocalidade[locKey] || row.DATA > allData.recentByLocalidade[locKey].DATA) {
                        allData.recentByLocalidade[locKey] = row;
                    }
                    
                    const munKey = row.NORMALIZED_MUNICIPIO;
                    if (!allData.recentByMunicipio[munKey] || row.DATA > allData.recentByMunicipio[munKey].DATA) {
                        allData.recentByMunicipio[munKey] = row;
                    }

                    allData.totalRem += row.REMOCOES;
                    allData.totalVias += row.VIAS;
                    allData.totalPeso += row.PESO_TON;
                });

                allData.avgPesoPerRem = allData.totalRem > 0 ? allData.totalPeso / allData.totalRem : 0;

                // Ordena localidades e municípios
                allData.sortedLocalidades = Object.values(allData.recentByLocalidade).sort((a, b) => b.REMOCOES - a.REMOCOES);
                allData.sortedMunicipios = Object.values(allData.recentByMunicipio).sort((a, b) => b.REMOCOES - a.REMOCOES);

                // Gera insights avançados
                const advancedInsights = generateAdvancedInsights(allData);
                allData.advancedInsights = advancedInsights;

                // Exibe análise
                let analysisHtml = `
                    <div class="col-md-3">
                        <div class="stat-card priority-high">
                            <div class="stat-value">${allData.totalRem}</div>
                            <div class="stat-label">Remoções Totais</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card priority-medium">
                            <div class="stat-value">${allData.totalVias}</div>
                            <div class="stat-label">Vias Liberadas</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card priority-low">
                            <div class="stat-value">${allData.totalPeso.toFixed(1)} ton</div>
                            <div class="stat-label">Peso Total</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-value">${allData.avgPesoPerRem.toFixed(2)} ton</div>
                            <div class="stat-label">Média Peso/Rem</div>
                        </div>
                    </div>
                    <div class="col-12 mt-4">
                        <div class="card card-custom">
                            <div class="card-header card-header-custom">
                                <h5 class="mb-0"><i class="bi bi-building"></i> Top 10 Municípios</h5>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-custom m-0">
                                    <thead>
                                        <tr>
                                            <th>Município</th>
                                            <th>Remoções</th>
                                            <th>Vias</th>
                                            <th>Peso (ton)</th>
                                            <th>Última Data</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${allData.sortedMunicipios.slice(0, 10).map(mun => `
                                            <tr>
                                                <td>${mun.MUNICIPIO}</td>
                                                <td>${mun.REMOCOES}</td>
                                                <td>${mun.VIAS}</td>
                                                <td>${mun.PESO_TON.toFixed(1)}</td>
                                                <td>${mun.FORMATTED_DATA}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 mt-4">
                        <div class="card card-custom">
                            <div class="card-header card-header-custom">
                                <h5 class="mb-0"><i class="bi bi-map"></i> Top 10 Localidades</h5>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-custom m-0">
                                    <thead>
                                        <tr>
                                            <th>Localidade</th>
                                            <th>Município</th>
                                            <th>Remoções</th>
                                            <th>Vias</th>
                                            <th>Peso (ton)</th>
                                            <th>Última Data</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${allData.sortedLocalidades.slice(0, 10).map(loc => `
                                            <tr>
                                                <td>${loc.LOCALIDADE_ID}</td>
                                                <td>${loc.MUNICIPIO}</td>
                                                <td>${loc.REMOCOES}</td>
                                                <td>${loc.VIAS}</td>
                                                <td>${loc.PESO_TON.toFixed(1)}</td>
                                                <td>${loc.FORMATTED_DATA}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 mt-4">
                        <div class="card insight-card card-custom">
                            <div class="card-header card-header-custom">
                                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Insights Principais - Análise Preditiva e Prescriptiva</h5>
                            </div>
                            <div class="card-body">
                                <div class="insights-container">
                                    ${advancedInsights.map((insight, index) => `
                                        <div class="insight-item ${insight.type}">
                                            <div class="insight-title">
                                                <i class="bi ${insight.icon} insight-icon"></i>
                                                ${insight.title}
                                            </div>
                                            <div class="insight-desc">${insight.description}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('analysis').innerHTML = analysisHtml;

                // Gera gráficos
                let chartsHtml = `
                    <div class="col-md-6">
                        <div class="card card-custom">
                            <div class="card-header card-header-custom">
                                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Remoções por Município</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="municipioChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card card-custom">
                            <div class="card-header card-header-custom">
                                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Distribuição por Área</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container-pie">
                                    <canvas id="areaChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('charts').innerHTML = chartsHtml;

                // Dados para gráficos
                const municipioLabels = allData.sortedMunicipios.slice(0, 10).map(m => m.MUNICIPIO);
                const municipioData = allData.sortedMunicipios.slice(0, 10).map(m => m.REMOCOES);

                const ctxMun = document.getElementById('municipioChart').getContext('2d');
                new Chart(ctxMun, {
                    type: 'bar',
                    data: {
                        labels: municipioLabels,
                        datasets: [{
                            label: 'Remoções',
                            data: municipioData,
                            backgroundColor: 'rgba(26, 95, 180, 0.6)',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });

                const areaCounts = {};
                allData.filteredData.forEach(row => {
                    areaCounts[row.AREA] = (areaCounts[row.AREA] || 0) + row.REMOCOES;
                });
                const areaLabels = Object.keys(areaCounts);
                const areaData = Object.values(areaCounts);

                const ctxArea = document.getElementById('areaChart').getContext('2d');
                new Chart(ctxArea, {
                    type: 'pie',
                    data: {
                        labels: areaLabels,
                        datasets: [{
                            data: areaData,
                            backgroundColor: ['#1a5fb4', '#26a269', '#e5a50a', '#e01b24', '#666', '#8a2be2', '#ff69b4', '#20b2aa']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 12,
                                    padding: 15
                                }
                            }
                        }
                    }
                });

                document.getElementById('planningSection').style.display = 'block';
                document.getElementById('pdfSection').style.display = 'block';
                
                // OCULTAR O BOTÃO "ANALISAR DADOS" APÓS ANÁLISE BEM-SUCEDIDA
                hideAnalyzeButton();
                
            } catch (error) {
                console.error('Erro ao processar workbook:', error);
                alert('Erro ao processar dados: ' + error.message);
                throw error;
            }
        }

        // Gerar planejamento
        function generatePlanning() {
            const startDateStr = document.getElementById('startDateInput').value;
            const numWeeks = parseInt(document.getElementById('weeksInput').value);
            const startDate = new Date(startDateStr);

            const weekdays = getNextWeekdays(startDate, numWeeks);
            const localidades = [];
            for (const key in allData.recentByLocalidade) {
                const data = allData.recentByLocalidade[key];
                const bpmValid = isBPMValidForLocalidade(data.BPM, data.LOCALIDADE_ID, data.BAIRRO, data.MUNICIPIO, allData.bpmValidationData);
                const intensityLevel = data.REMOCOES > 50 ? 'ALTA' : data.REMOCOES > 20 ? 'MEDIA' : 'BAIXA';
                const intensityColor = intensityLevel === 'ALTA' ? 'bg-danger' : intensityLevel === 'MEDIA' ? 'bg-warning' : 'bg-success';
                localidades.push({
                    localidadeNome: data.LOCALIDADE_ID,
                    municipio: data.MUNICIPIO,
                    cpa: data.CPA,
                    bpm: data.BPM,
                    bpmIsValid: bpmValid,
                    data: { rem: data.REMOCOES, peso: data.PESO_TON, vias: data.VIAS },
                    intensityLevel,
                    intensityColor
                });
            }

            // Ordenar localidades
            localidades.sort((a, b) => {
                const scoreA = (a.intensityLevel === 'ALTA' ? 3 : a.intensityLevel === 'MEDIA' ? 2 : 1) * 10000 + (a.bpmIsValid ? 1000 : 0) + a.data.rem * 10 + a.data.peso;
                const scoreB = (b.intensityLevel === 'ALTA' ? 3 : b.intensityLevel === 'MEDIA' ? 2 : 1) * 10000 + (b.bpmIsValid ? 1000 : 0) + b.data.rem * 10 + b.data.peso;
                return scoreB - scoreA;
            });

            const localidadesPorCPA = {};
            const localidadesPorMunicipio = {};
            localidades.forEach(loc => {
                if (!localidadesPorCPA[loc.cpa]) localidadesPorCPA[loc.cpa] = [];
                localidadesPorCPA[loc.cpa].push(loc);
                if (!localidadesPorMunicipio[loc.municipio]) localidadesPorMunicipio[loc.municipio] = [];
                localidadesPorMunicipio[loc.municipio].push(loc);
            });

            const numDays = weekdays.length;
            const distribuicaoPorDia = Array.from({ length: numDays }, () => []);
            const dayRemLoads = new Array(numDays).fill(0);
            const dayPesoLoads = new Array(numDays).fill(0);

            for (const loc of localidades) {
                let bestDay = -1;
                let bestScore = -Infinity;
                for (let d = 0; d < numDays; d++) {
                    if (distribuicaoPorDia[d].length >= 8) continue;
                    const cpaMatch = distribuicaoPorDia[d].filter(l => l.cpa === loc.cpa).length;
                    const munMatch = distribuicaoPorDia[d].filter(l => l.municipio === loc.municipio).length;
                    const matchScore = 10 * cpaMatch + 5 * munMatch;
                    const newRem = dayRemLoads[d] + loc.data.rem;
                    const newPeso = dayPesoLoads[d] + loc.data.peso;
                    const avgRem = dayRemLoads.reduce((sum, l) => sum + l, 0) / numDays;
                    const avgPeso = dayPesoLoads.reduce((sum, l) => sum + l, 0) / numDays;
                    const balanceScore = -((newRem - avgRem) ** 2 + (newPeso - avgPeso) ** 2);
                    const totalScore = matchScore + balanceScore;
                    if (totalScore > bestScore) {
                        bestScore = totalScore;
                        bestDay = d;
                    }
                }
                if (bestDay !== -1) {
                    distribuicaoPorDia[bestDay].push(loc);
                    dayRemLoads[bestDay] += loc.data.rem;
                    dayPesoLoads[bestDay] += loc.data.peso;
                }
            }

            // Post-processing to enforce 8 per day per week
            for (let w = 0; w < numWeeks; w++) {
                const weekDays = [];
                for (let d = w * 5; d < w * 5 + 5 && d < numDays; d++) {
                    weekDays.push(d);
                }

                let overDays = weekDays.filter(d => distribuicaoPorDia[d].length > 8);
                while (overDays.length > 0) {
                    for (const overD of overDays) {
                        const excess = distribuicaoPorDia[overD].length - 8;
                        for (let i = 0; i < excess; i++) {
                            const locToMove = distribuicaoPorDia[overD].pop();
                            const underDays = weekDays.filter(d => distribuicaoPorDia[d].length < 8);
                            let targetD;
                            if (underDays.length > 0) {
                                targetD = underDays.reduce((min, d) => distribuicaoPorDia[d].length < distribuicaoPorDia[min].length ? d : min, underDays[0]);
                            } else {
                                // Redistribute to other days in the plan
                                targetD = distribuicaoPorDia.reduce((minIdx, day, idx, arr) => day.length < arr[minIdx].length ? idx : minIdx, 0);
                            }
                            distribuicaoPorDia[targetD].push(locToMove);
                            dayRemLoads[overD] -= locToMove.data.rem;
                            dayPesoLoads[overD] -= locToMove.data.peso;
                            dayRemLoads[targetD] += locToMove.data.rem;
                            dayPesoLoads[targetD] += locToMove.data.peso;
                        }
                    }
                    overDays = weekDays.filter(d => distribuicaoPorDia[d].length > 8);
                }
            }

            let planningHtml = '';
            for (let semana = 0; semana < numWeeks; semana++) {
                planningHtml += `
                    <div class="col-12">
                        <div class="card week-card">
                            <div class="week-card-header">
                                Semana ${semana + 1}
                                <button class="btn btn-sm btn-light float-end view-week-details" data-week="${semana}">
                                    <i class="bi bi-eye"></i> Visualizar Detalhes
                                </button>
                            </div>
                            <div class="row no-gutters">
                `;
                for (let dia = 0; dia < 5; dia++) {
                    const diaGlobalIndex = semana * 5 + dia;
                    if (diaGlobalIndex >= numDays) break;
                    const date = weekdays[diaGlobalIndex];
                    planningHtml += `
                        <div class="col-md day-column">
                            <div class="day-header">
                                ${getDayNameFull(dia)} - ${formatDate(date)}
                                <span class="badge bg-primary ms-2">${distribuicaoPorDia[diaGlobalIndex].length} loc.</span>
                            </div>
                            <div class="scrollable-localidades">
                    `;
                    const localidadesDia = distribuicaoPorDia[diaGlobalIndex];
                    const cpaGroups = {};
                    localidadesDia.forEach(loc => {
                        if (!cpaGroups[loc.cpa]) cpaGroups[loc.cpa] = [];
                        cpaGroups[loc.cpa].push(loc);
                    });

                    Object.entries(cpaGroups).forEach(([cpa, localidadesCPA]) => {
                        planningHtml += `
                            <div class="cpa-group">
                                <div class="cpa-group-header">${cpa}</div>
                                <table class="localidade-table">
                                    <thead>
                                        <tr>
                                            <th width="35%">Localidade</th>
                                            <th width="25%">Município</th>
                                            <th width="20%">BPM</th>
                                            <th width="20%">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        localidadesCPA.sort((a, b) => a.municipio.localeCompare(b.municipio));
                        
                        localidadesCPA.forEach(localidade => {
                            const bpmStatus = localidade.bpmIsValid ? 
                                `<span class="badge bg-success compact-badge">${localidade.bpm}</span>` :
                                `<span class="badge bg-warning compact-badge">${localidade.bpm}</span>`;
                            
                            planningHtml += `
                                <tr>
                                    <td>
                                        <strong>${localidade.localidadeNome}</strong><br>
                                        <small class="text-muted">${localidade.data.rem} rem | ${localidade.data.peso.toFixed(1)} ton</small>
                                    </td>
                                    <td>${localidade.municipio}</td>
                                    <td>${bpmStatus}</td>
                                    <td>
                                        <span class="badge ${localidade.intensityColor} compact-badge">${localidade.intensityLevel}</span>
                                        ${localidade.bpmIsValid ? 
                                            '<span class="badge bg-success compact-badge">BPM OK</span>' : 
                                            '<span class="badge bg-warning compact-badge">Sem BPM</span>'
                                        }
                                    </td>
                                </tr>
                            `;
                        });
                        
                        planningHtml += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    });
                    
                    planningHtml += `
                            </div>
                            <button class="btn btn-sm btn-outline-primary w-100 mt-2 view-day-details" 
                                    data-week="${semana}" 
                                    data-day="${dia}" 
                                    data-date="${formatDate(date)}">
                                <i class="bi bi-zoom-in"></i> Ver Detalhes do Dia
                            </button>
                        </div>
                    `;
                }
                
                planningHtml += `
                        </div>
                    </div>
                `;
            }

            // Resumo Estatístico
            planningHtml += `
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-shield"></i> Top CPAs por Localidades</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>CPA</th>
                                                    <th>Localidades</th>
                                                    <th>Com BPM</th>
                                                    <th>Distribuição/Dia</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(localidadesPorCPA)
                                                    .sort((a, b) => b[1].length - a[1].length)
                                                    .slice(0, 10)
                                                    .map(([cpa, locs]) => {
                                                        const comBPM = locs.filter(l => l.bpmIsValid).length;
                                                        const diasComCPA = new Set();
                                                        distribuicaoPorDia.forEach((dia, idx) => {
                                                            if (dia.some(loc => loc.cpa === cpa)) {
                                                                diasComCPA.add(idx);
                                                            }
                                                        });
                                                        return `
                                                            <tr>
                                                                <td>${cpa}</td>
                                                                <td><span class="badge bg-primary">${locs.length}</span></td>
                                                                <td><span class="badge ${comBPM > 0 ? 'bg-success' : 'bg-secondary'}">${comBPM}</span></td>
                                                                <td><span class="badge bg-info">${diasComCPA.size} dias</span></td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary w-100 mt-2 view-cpa-summary">
                                        <i class="bi bi-list-ul"></i> Ver Resumo Completo de CPAs
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-building"></i> Top Municípios por Localidades</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Município</th>
                                                    <th>Localidades</th>
                                                    <th>Com BPM</th>
                                                    <th>CPAs</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(localidadesPorMunicipio)
                                                    .sort((a, b) => b[1].length - a[1].length)
                                                    .slice(0, 10)
                                                    .map(([municipio, locs]) => {
                                                        const comBPM = locs.filter(l => l.bpmIsValid).length;
                                                        const cpas = new Set(locs.map(l => l.cpa)).size;
                                                        return `
                                                            <tr>
                                                                <td>${municipio}</td>
                                                                <td><span class="badge bg-primary">${locs.length}</span></td>
                                                                <td><span class="badge ${comBPM > 0 ? 'bg-success' : 'bg-secondary'}">${comBPM}</span></td>
                                                                <td><span class="badge bg-info">${cpas}</span></td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary w-100 mt-2 view-municipio-summary">
                                        <i class="bi bi-building"></i> Ver Resumo Completo de Municípios
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

            document.getElementById('planning').innerHTML = planningHtml;

            allData.planningData = {
                distribuicaoPorDia,
                localidadesPorCPA,
                localidadesPorMunicipio,
                semanas: numWeeks,
                weekdays,
                startDate: startDateStr,
                numWeeks
            };
        }
        
        // Mostrar detalhes da semana
        function showWeekDetails(weekNum) {
            if (!allData.planningData) return;
            
            const { distribuicaoPorDia, weekdays } = allData.planningData;
            const weekStart = weekNum * 5;
            const weekEnd = Math.min(weekStart + 5, weekdays.length);
            
            let modalContent = `
                <div class="text-center mb-4">
                    <h4 class="text-primary">Detalhes da Semana ${weekNum + 1}</h4>
                    <p class="text-muted">${formatDate(weekdays[weekStart])} a ${formatDate(weekdays[weekEnd - 1])}</p>
                </div>
                
                <div class="row">
            `;
            
            for (let d = 0; d < 5; d++) {
                const diaGlobalIndex = weekNum * 5 + d;
                if (diaGlobalIndex >= weekdays.length) break;
                
                const date = weekdays[diaGlobalIndex];
                const localidadesDia = distribuicaoPorDia[diaGlobalIndex] || [];
                
                modalContent += `
                    <div class="col-md-12 mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">${getDayNameFull(d)} - ${formatDate(date)}</h6>
                                <span class="badge bg-primary">${localidadesDia.length} localidades</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Localidade</th>
                                                <th>Município</th>
                                                <th>CPA</th>
                                                <th>BPM</th>
                                                <th>Remoções</th>
                                                <th>Peso (ton)</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                `;
                
                localidadesDia.forEach(loc => {
                    modalContent += `
                        <tr>
                            <td><strong>${loc.localidadeNome}</strong></td>
                            <td>${loc.municipio}</td>
                            <td>${loc.cpa}</td>
                            <td>${loc.bpm}</td>
                            <td>${loc.data.rem}</td>
                            <td>${loc.data.peso.toFixed(1)}</td>
                            <td>
                                <span class="badge ${loc.intensityColor}">${loc.intensityLevel}</span>
                                ${loc.bpmIsValid ? 
                                    '<span class="badge bg-success">BPM OK</span>' : 
                                    '<span class="badge bg-warning">Sem BPM</span>'
                                }
                            </td>
                        </tr>
                    `;
                });
                
                modalContent += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            modalContent += `</div>`;
            
            document.getElementById('planningDetailContent').innerHTML = modalContent;
            currentModalType = 'week';
            currentModalData = { 
                weekNum, 
                weekStart, 
                weekEnd, 
                weekdays, 
                distribuicaoPorDia: allData.planningData.distribuicaoPorDia 
            };
            
            const modal = new bootstrap.Modal(document.getElementById('planningDetailModal'));
            modal.show();
        }
        
        // Mostrar detalhes do dia
        function showDayDetails(weekNum, dayNum, dateStr) {
            if (!allData.planningData) return;
            
            const { distribuicaoPorDia, weekdays } = allData.planningData;
            const diaGlobalIndex = weekNum * 5 + dayNum;
            const localidadesDia = distribuicaoPorDia[diaGlobalIndex] || [];
            const date = weekdays[diaGlobalIndex];
            
            // Agrupar por CPA para melhor organização
            const cpaGroups = {};
            localidadesDia.forEach(loc => {
                if (!cpaGroups[loc.cpa]) cpaGroups[loc.cpa] = [];
                cpaGroups[loc.cpa].push(loc);
            });
            
            let modalContent = `
                <div class="text-center mb-4">
                    <h4 class="text-primary">Detalhes do Dia</h4>
                    <p class="lead">${getDayNameFull(dayNum)} - ${dateStr}</p>
                    <div class="row justify-content-center">
                        <div class="col-auto">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <span class="badge bg-primary">${localidadesDia.length} Localidades</span>
                                    <span class="badge bg-success ms-2">${localidadesDia.filter(l => l.bpmIsValid).length} com BPM</span>
                                    <span class="badge bg-warning ms-2">${localidadesDia.filter(l => !l.bpmIsValid).length} sem BPM</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="accordion" id="dayDetailsAccordion">
            `;
            
            let cpaIndex = 0;
            for (const [cpa, localidades] of Object.entries(cpaGroups)) {
                const totalRem = localidades.reduce((sum, loc) => sum + loc.data.rem, 0);
                const totalPeso = localidades.reduce((sum, loc) => sum + loc.data.peso, 0);
                const comBPM = localidades.filter(loc => loc.bpmIsValid).length;
                
                modalContent += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading${cpaIndex}">
                            <button class="accordion-button ${cpaIndex > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${cpaIndex}" aria-expanded="${cpaIndex === 0 ? 'true' : 'false'}" aria-controls="collapse${cpaIndex}">
                                <strong>${cpa}</strong>
                                <span class="badge bg-primary ms-2">${localidades.length} loc.</span>
                                <span class="badge bg-info ms-2">${totalRem} rem</span>
                                <span class="badge bg-secondary ms-2">${totalPeso.toFixed(1)} ton</span>
                                <span class="badge ${comBPM > 0 ? 'bg-success' : 'bg-warning'} ms-2">${comBPM} com BPM</span>
                            </button>
                        </h2>
                        <div id="collapse${cpaIndex}" class="accordion-collapse collapse ${cpaIndex === 0 ? 'show' : ''}" aria-labelledby="heading${cpaIndex}" data-bs-parent="#dayDetailsAccordion">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Localidade</th>
                                                <th>Município</th>
                                                <th>BPM</th>
                                                <th>Remoções</th>
                                                <th>Peso (ton)</th>
                                                <th>Vias</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                `;
                
                localidades.forEach(loc => {
                    modalContent += `
                        <tr>
                            <td><strong>${loc.localidadeNome}</strong></td>
                            <td>${loc.municipio}</td>
                            <td>${loc.bpm}</td>
                            <td>${loc.data.rem}</td>
                            <td>${loc.data.peso.toFixed(1)}</td>
                            <td>${loc.data.vias || 'N/A'}</td>
                            <td>
                                <span class="badge ${loc.intensityColor}">${loc.intensityLevel}</span>
                                ${loc.bpmIsValid ? 
                                    '<span class="badge bg-success">Validado</span>' : 
                                    '<span class="badge bg-warning">Não Validado</span>'
                                }
                            </td>
                        </tr>
                    `;
                });
                
                modalContent += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                cpaIndex++;
            }
            
            modalContent += `
                </div>
                
                <div class="mt-4 p-3 bg-light rounded">
                    <h6 class="mb-3"><i class="bi bi-graph-up"></i> Resumo Estatístico do Dia</h6>
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <h4 class="text-primary">${localidadesDia.length}</h4>
                                <small class="text-muted">Localidades</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <h4 class="text-success">${localidadesDia.filter(l => l.bpmIsValid).length}</h4>
                                <small class="text-muted">Com BPM Validado</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <h4 class="text-warning">${localidadesDia.filter(l => !l.bpmIsValid).length}</h4>
                                <small class="text-muted">Sem BPM Validado</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <h4 class="text-danger">${localidadesDia.filter(l => l.intensityLevel === 'ALTA').length}</h4>
                                <small class="text-muted">Prioridade ALTA</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('planningDetailContent').innerHTML = modalContent;
            currentModalType = 'day';
            currentModalData = { 
                weekNum, 
                dayNum, 
                dateStr, 
                diaGlobalIndex, 
                localidadesDia, 
                cpaGroups 
            };
            
            const modal = new bootstrap.Modal(document.getElementById('planningDetailModal'));
            modal.show();
        }
        
        // Mostrar resumo de CPAs
        function showCPASummary() {
            if (!allData.planningData) return;
            
            const { localidadesPorCPA, distribuicaoPorDia } = allData.planningData;
            
            let modalContent = `
                <div class="text-center mb-4">
                    <h4 class="text-primary">Resumo Completo de CPAs</h4>
                    <p class="text-muted">Distribuição de localidades por CPA no planejamento</p>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>CPA</th>
                                <th>Total Localidades</th>
                                <th>Com BPM Validado</th>
                                <th>Sem BPM</th>
                                <th>% Cobertura</th>
                                <th>Dias no Planejamento</th>
                                <th>Prioridade ALTA</th>
                                <th>Prioridade MÉDIA</th>
                                <th>Prioridade BAIXA</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            const cpasOrdenadas = Object.entries(localidadesPorCPA)
                .sort((a, b) => b[1].length - a[1].length);
            
            cpasOrdenadas.forEach(([cpa, localidades]) => {
                const comBPM = localidades.filter(l => l.bpmIsValid).length;
                const semBPM = localidades.length - comBPM;
                const cobertura = localidades.length > 0 ? Math.round((comBPM / localidades.length) * 100) : 0;
                
                // Calcular em quantos dias esta CPA aparece
                const diasComCPA = new Set();
                distribuicaoPorDia.forEach((dia, idx) => {
                    if (dia.some(loc => loc.cpa === cpa)) {
                        diasComCPA.add(idx);
                    }
                });
                
                const prioridadeAlta = localidades.filter(l => l.intensityLevel === 'ALTA').length;
                const prioridadeMedia = localidades.filter(l => l.intensityLevel === 'MEDIA').length;
                const prioridadeBaixa = localidades.filter(l => l.intensityLevel === 'BAIXA').length;
                
                modalContent += `
                    <tr>
                        <td><strong>${cpa}</strong></td>
                        <td><span class="badge bg-primary">${localidades.length}</span></td>
                        <td><span class="badge bg-success">${comBPM}</span></td>
                        <td><span class="badge bg-warning">${semBPM}</span></td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar ${cobertura >= 70 ? 'bg-success' : cobertura >= 40 ? 'bg-warning' : 'bg-danger'}" 
                                     role="progressbar" style="width: ${cobertura}%;" 
                                     aria-valuenow="${cobertura}" aria-valuemin="0" aria-valuemax="100">
                                    ${cobertura}%
                                </div>
                            </div>
                        </td>
                        <td><span class="badge bg-info">${diasComCPA.size}</span></td>
                        <td><span class="badge bg-danger">${prioridadeAlta}</span></td>
                        <td><span class="badge bg-warning">${prioridadeMedia}</span></td>
                        <td><span class="badge bg-success">${prioridadeBaixa}</span></td>
                    </tr>
                `;
            });
            
            modalContent += `
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 p-3 bg-light rounded">
                    <h6 class="mb-3"><i class="bi bi-bar-chart"></i> Estatísticas Gerais</h6>
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <h4 class="text-primary">${Object.keys(localidadesPorCPA).length}</h4>
                                <small class="text-muted">Total de CPAs</small>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <h4 class="text-success">${cpasOrdenadas.reduce((max, cpa) => Math.max(max, cpa[1].length), 0)}</h4>
                                <small class="text-muted">Maior CPA (localidades)</small>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <h4 class="text-info">${Math.round(cpasOrdenadas.reduce((sum, cpa) => sum + cpa[1].length, 0) / Object.keys(localidadesPorCPA).length)}</h4>
                                <small class="text-muted">Média por CPA</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('planningDetailContent').innerHTML = modalContent;
            currentModalType = 'cpa';
            currentModalData = { 
                localidadesPorCPA: allData.planningData.localidadesPorCPA, 
                cpasOrdenadas, 
                distribuicaoPorDia: allData.planningData.distribuicaoPorDia 
            };
            
            const modal = new bootstrap.Modal(document.getElementById('planningDetailModal'));
            modal.show();
        }
        
        // Mostrar resumo de municípios
        function showMunicipioSummary() {
            if (!allData.planningData) return;
            
            const { localidadesPorMunicipio } = allData.planningData;
            
            let modalContent = `
                <div class="text-center mb-4">
                    <h4 class="text-primary">Resumo Completo de Municípios</h4>
                    <p class="text-muted">Distribuição de localidades por município no planejamento</p>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Município</th>
                                <th>Total Localidades</th>
                                <th>Com BPM Validado</th>
                                <th>Sem BPM</th>
                                <th>% Cobertura</th>
                                <th>CPAs Envolvidas</th>
                                <th>Prioridade ALTA</th>
                                <th>Prioridade MÉDIA</th>
                                <th>Prioridade BAIXA</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            const municipiosOrdenados = Object.entries(localidadesPorMunicipio)
                .sort((a, b) => b[1].length - a[1].length);
            
            municipiosOrdenados.forEach(([municipio, localidades]) => {
                const comBPM = localidades.filter(l => l.bpmIsValid).length;
                const semBPM = localidades.length - comBPM;
                const cobertura = localidades.length > 0 ? Math.round((comBPM / localidades.length) * 100) : 0;
                
                // Calcular quantas CPAs diferentes atuam neste município
                const cpas = new Set(localidades.map(l => l.cpa)).size;
                
                const prioridadeAlta = localidades.filter(l => l.intensityLevel === 'ALTA').length;
                const prioridadeMedia = localidades.filter(l => l.intensityLevel === 'MEDIA').length;
                const prioridadeBaixa = localidades.filter(l => l.intensityLevel === 'BAIXA').length;
                
                modalContent += `
                    <tr>
                        <td><strong>${municipio}</strong></td>
                        <td><span class="badge bg-primary">${localidades.length}</span></td>
                        <td><span class="badge bg-success">${comBPM}</span></td>
                        <td><span class="badge bg-warning">${semBPM}</span></td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar ${cobertura >= 70 ? 'bg-success' : cobertura >= 40 ? 'bg-warning' : 'bg-danger'}" 
                                     role="progressbar" style="width: ${cobertura}%;" 
                                     aria-valuenow="${cobertura}" aria-valuemin="0" aria-valuemax="100">
                                    ${cobertura}%
                                </div>
                            </div>
                        </td>
                        <td><span class="badge bg-info">${cpas}</span></td>
                        <td><span class="badge bg-danger">${prioridadeAlta}</span></td>
                        <td><span class="badge bg-warning">${prioridadeMedia}</span></td>
                        <td><span class="badge bg-success">${prioridadeBaixa}</span></td>
                    </tr>
                `;
            });
            
            modalContent += `
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 p-3 bg-light rounded">
                    <h6 class="mb-3"><i class="bi bi-bar-chart"></i> Estatísticas Gerais</h6>
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <h4 class="text-primary">${Object.keys(localidadesPorMunicipio).length}</h4>
                                <small class="text-muted">Total de Municípios</small>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <h4 class="text-success">${municipiosOrdenados.reduce((max, mun) => Math.max(max, mun[1].length), 0)}</h4>
                                <small class="text-muted">Maior Município (localidades)</small>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="p-3 bg-white rounded shadow-sm">
                                <h4 class="text-info">${Math.round(municipiosOrdenados.reduce((sum, mun) => sum + mun[1].length, 0) / Object.keys(localidadesPorMunicipio).length)}</h4>
                                <small class="text-muted">Média por Município</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('planningDetailContent').innerHTML = modalContent;
            currentModalType = 'municipio';
            currentModalData = { 
                localidadesPorMunicipio: allData.planningData.localidadesPorMunicipio, 
                municipiosOrdenados 
            };
            
            const modal = new bootstrap.Modal(document.getElementById('planningDetailModal'));
            modal.show();
        }
        
        // CORREÇÃO PRINCIPAL: Função para exportar conteúdo do modal para PDF
        function exportModalToPDF() {
            console.log('Iniciando exportação do modal para PDF...');
            
            if (!currentModalType || !currentModalData) {
                alert('Nenhum dado disponível para exportação. Por favor, abra um modal primeiro.');
                return;
            }
            
            // Mostrar loading no modal
            const modalLoading = document.getElementById('modalLoadingPdf');
            if (modalLoading) {
                modalLoading.style.display = 'flex';
            }
            
            // Usar setTimeout para permitir que o loading seja mostrado
            setTimeout(() => {
                try {
                    // Verificar se jsPDF está disponível
                    if (typeof window.jspdf === 'undefined') {
                        throw new Error('A biblioteca jsPDF não foi carregada corretamente.');
                    }
                    
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 15;
                    let yPos = margin;
                    const today = new Date();
                    
                    // Configurações comuns
                    const primaryColor = [26, 95, 180];
                    const secondaryColor = [38, 162, 105];
                    
                    // Cabeçalho do PDF
                    doc.setFillColor(...primaryColor);
                    doc.rect(0, 0, pageWidth, 20, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    
                    let title = '';
                    let fileName = '';
                    let subtitle = '';
                    
                    // Configurar título baseado no tipo de modal
                    switch(currentModalType) {
                        case 'week':
                            title = `Detalhes da Semana ${currentModalData.weekNum + 1}`;
                            fileName = `Semana_${currentModalData.weekNum + 1}_Detalhes.pdf`;
                            subtitle = `${formatDate(currentModalData.weekdays[currentModalData.weekStart])} a ${formatDate(currentModalData.weekdays[currentModalData.weekEnd - 1])}`;
                            break;
                        case 'day':
                            title = `Detalhes do Dia - ${currentModalData.dateStr}`;
                            fileName = `Dia_${currentModalData.dateStr.replace(/\//g, '-')}_Detalhes.pdf`;
                            subtitle = `${getDayNameFull(currentModalData.dayNum)}`;
                            break;
                        case 'cpa':
                            title = 'Resumo Completo de CPAs';
                            fileName = 'Resumo_CPAs.pdf';
                            subtitle = 'Distribuição de localidades por CPA no planejamento';
                            break;
                        case 'municipio':
                            title = 'Resumo Completo de Municípios';
                            fileName = 'Resumo_Municipios.pdf';
                            subtitle = 'Distribuição de localidades por município no planejamento';
                            break;
                    }
                    
                    doc.text(title, pageWidth/2, 12, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.text(`Operação Barricada Zero - ${today.toLocaleDateString('pt-BR')}`, pageWidth/2, 18, { align: 'center' });
                    
                    yPos = 30;
                    
                    // Subtítulo se houver
                    if (subtitle) {
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'normal');
                        doc.text(subtitle, pageWidth/2, yPos, { align: 'center' });
                        yPos += 10;
                    }
                    
                    // Conteúdo específico para cada tipo de modal
                    switch(currentModalType) {
                        case 'week':
                            exportWeekDetailsToPDF(doc, currentModalData, pageWidth, pageHeight, margin, yPos);
                            break;
                        case 'day':
                            exportDayDetailsToPDF(doc, currentModalData, pageWidth, pageHeight, margin, yPos);
                            break;
                        case 'cpa':
                            exportCPADetailsToPDF(doc, currentModalData, pageWidth, pageHeight, margin, yPos);
                            break;
                        case 'municipio':
                            exportMunicipioDetailsToPDF(doc, currentModalData, pageWidth, pageHeight, margin, yPos);
                            break;
                    }
                    
                    // Adicionar numeração de páginas
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text(`Página ${i} de ${totalPages}`, pageWidth/2, pageHeight - 10, { align: 'center' });
                    }
                    
                    // Baixar o PDF
                    console.log('Salvando PDF:', fileName);
                    doc.save(fileName);
                    
                } catch (error) {
                    console.error('Erro ao gerar PDF do modal:', error);
                    alert('Erro ao gerar PDF: ' + error.message);
                } finally {
                    // Esconder loading
                    const modalLoading = document.getElementById('modalLoadingPdf');
                    if (modalLoading) {
                        modalLoading.style.display = 'none';
                    }
                }
            }, 500);
        }
        
        // Função para exportar detalhes da semana para PDF
        function exportWeekDetailsToPDF(doc, data, pageWidth, pageHeight, margin, yPos) {
            const { weekNum, weekdays, distribuicaoPorDia } = data;
            const weekStart = weekNum * 5;
            const weekEnd = Math.min(weekStart + 5, weekdays.length);
            
            // Para cada dia da semana
            for (let d = 0; d < 5; d++) {
                const diaGlobalIndex = weekNum * 5 + d;
                if (diaGlobalIndex >= weekdays.length) break;
                
                const date = weekdays[diaGlobalIndex];
                const localidadesDia = distribuicaoPorDia[diaGlobalIndex] || [];
                
                // Verificar se precisa de nova página
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = margin;
                }
                
                // Título do dia
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text(`${getDayNameFull(d)} - ${formatDate(date)} (${localidadesDia.length} localidades)`, margin + 5, yPos + 5.5);
                yPos += 10;
                
                if (localidadesDia.length === 0) {
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text('Nenhuma localidade agendada para este dia.', margin + 5, yPos);
                    yPos += 8;
                } else {
                    // Tabela de localidades
                    const tableData = localidadesDia.map(loc => [
                        loc.localidadeNome.length > 25 ? loc.localidadeNome.substring(0, 22) + '...' : loc.localidadeNome,
                        loc.municipio.length > 15 ? loc.municipio.substring(0, 12) + '...' : loc.municipio,
                        loc.cpa.length > 15 ? loc.cpa.substring(0, 12) + '...' : loc.cpa,
                        loc.bpm.length > 15 ? loc.bpm.substring(0, 12) + '...' : loc.bpm,
                        loc.data.rem.toString(),
                        loc.data.peso.toFixed(1),
                        loc.intensityLevel,
                        loc.bpmIsValid ? 'SIM' : 'NÃO'
                    ]);
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Localidade', 'Município', 'CPA', 'BPM', 'Rem', 'Peso', 'Prior.', 'BPM Val.']],
                        body: tableData,
                        styles: { 
                            fontSize: 8,
                            cellPadding: 2,
                            overflow: 'linebreak'
                        },
                        headStyles: { 
                            fillColor: [26, 95, 180],
                            textColor: [255, 255, 255],
                            fontStyle: 'bold'
                        },
                        columnStyles: {
                            0: { cellWidth: 35 },
                            1: { cellWidth: 30 },
                            2: { cellWidth: 25 },
                            3: { cellWidth: 25 },
                            4: { cellWidth: 15, halign: 'center' },
                            5: { cellWidth: 20, halign: 'center' },
                            6: { cellWidth: 15, halign: 'center' },
                            7: { cellWidth: 15, halign: 'center' }
                        },
                        margin: { left: margin, right: margin },
                        didParseCell: function(data) {
                            if (data.column.index === 6 && data.section === 'body') {
                                if (data.cell.raw === 'ALTA') {
                                    data.cell.styles.textColor = [224, 27, 36];
                                    data.cell.styles.fontStyle = 'bold';
                                } else if (data.cell.raw === 'MEDIA') {
                                    data.cell.styles.textColor = [229, 165, 10];
                                } else {
                                    data.cell.styles.textColor = [38, 162, 105];
                                }
                            }
                            if (data.column.index === 7 && data.section === 'body') {
                                if (data.cell.raw === 'SIM') {
                                    data.cell.styles.textColor = [38, 162, 105];
                                    data.cell.styles.fontStyle = 'bold';
                                } else {
                                    data.cell.styles.textColor = [229, 165, 10];
                                }
                            }
                        }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 10;
                }
                
                // Espaço entre dias
                if (d < 4) {
                    yPos += 5;
                }
            }
        }
        
        // Função para exportar detalhes do dia para PDF
        function exportDayDetailsToPDF(doc, data, pageWidth, pageHeight, margin, yPos) {
            const { dateStr, localidadesDia, cpaGroups } = data;
            
            // Estatísticas do dia
            const totalLocalidades = localidadesDia.length;
            const comBPM = localidadesDia.filter(l => l.bpmIsValid).length;
            const semBPM = totalLocalidades - comBPM;
            const prioridadeAlta = localidadesDia.filter(l => l.intensityLevel === 'ALTA').length;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de Localidades: ${totalLocalidades} | Com BPM: ${comBPM} | Sem BPM: ${semBPM} | Prioridade ALTA: ${prioridadeAlta}`, margin, yPos);
            yPos += 10;
            
            // Agrupar por CPA
            for (const [cpa, localidades] of Object.entries(cpaGroups)) {
                // Verificar se precisa de nova página
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = margin;
                }
                
                // Título da CPA
                doc.setFillColor(240, 247, 255);
                doc.rect(margin, yPos, pageWidth - 2*margin, 8, 'F');
                doc.setTextColor(26, 95, 180);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text(`CPA: ${cpa} (${localidades.length} localidades)`, margin + 5, yPos + 5.5);
                yPos += 10;
                
                // Tabela de localidades da CPA
                const tableData = localidades.map(loc => [
                    loc.localidadeNome.length > 25 ? loc.localidadeNome.substring(0, 22) + '...' : loc.localidadeNome,
                    loc.municipio.length > 15 ? loc.municipio.substring(0, 12) + '...' : loc.municipio,
                    loc.bpm.length > 20 ? loc.bpm.substring(0, 17) + '...' : loc.bpm,
                    loc.data.rem.toString(),
                    loc.data.peso.toFixed(1),
                    loc.data.vias || '0',
                    loc.intensityLevel,
                    loc.bpmIsValid ? 'SIM' : 'NÃO'
                ]);
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Localidade', 'Município', 'BPM', 'Rem', 'Peso', 'Vias', 'Prior.', 'BPM Val.']],
                    body: tableData,
                    styles: { 
                        fontSize: 8,
                        cellPadding: 2,
                        overflow: 'linebreak'
                    },
                    headStyles: { 
                        fillColor: [38, 162, 105],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        0: { cellWidth: 35 },
                        1: { cellWidth: 25 },
                        2: { cellWidth: 30 },
                        3: { cellWidth: 15, halign: 'center' },
                        4: { cellWidth: 20, halign: 'center' },
                        5: { cellWidth: 15, halign: 'center' },
                        6: { cellWidth: 15, halign: 'center' },
                        7: { cellWidth: 15, halign: 'center' }
                    },
                    margin: { left: margin, right: margin },
                    didParseCell: function(data) {
                        if (data.column.index === 6 && data.section === 'body') {
                            if (data.cell.raw === 'ALTA') {
                                data.cell.styles.textColor = [224, 27, 36];
                                data.cell.styles.fontStyle = 'bold';
                            } else if (data.cell.raw === 'MEDIA') {
                                data.cell.styles.textColor = [229, 165, 10];
                            } else {
                                data.cell.styles.textColor = [38, 162, 105];
                            }
                        }
                        if (data.column.index === 7 && data.section === 'body') {
                            if (data.cell.raw === 'SIM') {
                                data.cell.styles.textColor = [38, 162, 105];
                                data.cell.styles.fontStyle = 'bold';
                            } else {
                                data.cell.styles.textColor = [229, 165, 10];
                            }
                        }
                    }
                });
                
                yPos = doc.lastAutoTable.finalY + 10;
                
                // Espaço entre CPAs
                yPos += 5;
            }
        }
        
        // Função para exportar resumo de CPAs para PDF
        function exportCPADetailsToPDF(doc, data, pageWidth, pageHeight, margin, yPos) {
            const { cpasOrdenadas, distribuicaoPorDia } = data;
            
            // Estatísticas gerais
            const totalCPAs = cpasOrdenadas.length;
            const totalLocalidades = cpasOrdenadas.reduce((sum, cpa) => sum + cpa[1].length, 0);
            const mediaPorCPA = Math.round(totalLocalidades / totalCPAs);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de CPAs: ${totalCPAs} | Total de Localidades: ${totalLocalidades} | Média: ${mediaPorCPA} localidades/CPA`, margin, yPos);
            yPos += 10;
            
            // Tabela de CPAs
            const tableData = cpasOrdenadas.map(([cpa, localidades]) => {
                const comBPM = localidades.filter(l => l.bpmIsValid).length;
                const semBPM = localidades.length - comBPM;
                const cobertura = localidades.length > 0 ? Math.round((comBPM / localidades.length) * 100) : 0;
                
                // Calcular em quantos dias esta CPA aparece
                const diasComCPA = new Set();
                distribuicaoPorDia.forEach((dia, idx) => {
                    if (dia.some(loc => loc.cpa === cpa)) {
                        diasComCPA.add(idx);
                    }
                });
                
                const prioridadeAlta = localidades.filter(l => l.intensityLevel === 'ALTA').length;
                const prioridadeMedia = localidades.filter(l => l.intensityLevel === 'MEDIA').length;
                const prioridadeBaixa = localidades.filter(l => l.intensityLevel === 'BAIXA').length;
                
                return [
                    cpa.length > 25 ? cpa.substring(0, 22) + '...' : cpa,
                    localidades.length.toString(),
                    comBPM.toString(),
                    semBPM.toString(),
                    cobertura + '%',
                    diasComCPA.size.toString(),
                    prioridadeAlta.toString(),
                    prioridadeMedia.toString(),
                    prioridadeBaixa.toString()
                ];
            });
            
            doc.autoTable({
                startY: yPos,
                head: [['CPA', 'Total', 'Com BPM', 'Sem BPM', '% Cob.', 'Dias', 'ALTA', 'MÉDIA', 'BAIXA']],
                body: tableData,
                styles: { 
                    fontSize: 8,
                    cellPadding: 2,
                    overflow: 'linebreak'
                },
                headStyles: { 
                    fillColor: [26, 95, 180],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 15, halign: 'center' },
                    2: { cellWidth: 15, halign: 'center' },
                    3: { cellWidth: 15, halign: 'center' },
                    4: { cellWidth: 15, halign: 'center' },
                    5: { cellWidth: 15, halign: 'center' },
                    6: { cellWidth: 15, halign: 'center' },
                    7: { cellWidth: 15, halign: 'center' },
                    8: { cellWidth: 15, halign: 'center' }
                },
                margin: { left: margin, right: margin },
                didParseCell: function(data) {
                    if (data.column.index === 4 && data.section === 'body') {
                        const value = parseInt(data.cell.raw);
                        if (value >= 70) {
                            data.cell.styles.textColor = [38, 162, 105];
                            data.cell.styles.fontStyle = 'bold';
                        } else if (value >= 40) {
                            data.cell.styles.textColor = [229, 165, 10];
                        } else {
                            data.cell.styles.textColor = [224, 27, 36];
                        }
                    }
                }
            });
        }
        
        // Função para exportar resumo de municípios para PDF
        function exportMunicipioDetailsToPDF(doc, data, pageWidth, pageHeight, margin, yPos) {
            const { municipiosOrdenados } = data;
            
            // Estatísticas gerais
            const totalMunicipios = municipiosOrdenados.length;
            const totalLocalidades = municipiosOrdenados.reduce((sum, mun) => sum + mun[1].length, 0);
            const mediaPorMunicipio = Math.round(totalLocalidades / totalMunicipios);
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Total de Municípios: ${totalMunicipios} | Total de Localidades: ${totalLocalidades} | Média: ${mediaPorMunicipio} localidades/município`, margin, yPos);
            yPos += 10;
            
            // Tabela de municípios
            const tableData = municipiosOrdenados.map(([municipio, localidades]) => {
                const comBPM = localidades.filter(l => l.bpmIsValid).length;
                const semBPM = localidades.length - comBPM;
                const cobertura = localidades.length > 0 ? Math.round((comBPM / localidades.length) * 100) : 0;
                
                // Calcular quantas CPAs diferentes atuam neste município
                const cpas = new Set(localidades.map(l => l.cpa)).size;
                
                const prioridadeAlta = localidades.filter(l => l.intensityLevel === 'ALTA').length;
                const prioridadeMedia = localidades.filter(l => l.intensityLevel === 'MEDIA').length;
                const prioridadeBaixa = localidades.filter(l => l.intensityLevel === 'BAIXA').length;
                
                return [
                    municipio.length > 25 ? municipio.substring(0, 22) + '...' : municipio,
                    localidades.length.toString(),
                    comBPM.toString(),
                    semBPM.toString(),
                    cobertura + '%',
                    cpas.toString(),
                    prioridadeAlta.toString(),
                    prioridadeMedia.toString(),
                    prioridadeBaixa.toString()
                ];
            });
            
            doc.autoTable({
                startY: yPos,
                head: [['Município', 'Total', 'Com BPM', 'Sem BPM', '% Cob.', 'CPAs', 'ALTA', 'MÉDIA', 'BAIXA']],
                body: tableData,
                styles: { 
                    fontSize: 8,
                    cellPadding: 2,
                    overflow: 'linebreak'
                },
                headStyles: { 
                    fillColor: [38, 162, 105],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { cellWidth: 40 },
                    1: { cellWidth: 15, halign: 'center' },
                    2: { cellWidth: 15, halign: 'center' },
                    3: { cellWidth: 15, halign: 'center' },
                    4: { cellWidth: 15, halign: 'center' },
                    5: { cellWidth: 15, halign: 'center' },
                    6: { cellWidth: 15, halign: 'center' },
                    7: { cellWidth: 15, halign: 'center' },
                    8: { cellWidth: 15, halign: 'center' }
                },
                margin: { left: margin, right: margin },
                didParseCell: function(data) {
                    if (data.column.index === 4 && data.section === 'body') {
                        const value = parseInt(data.cell.raw);
                        if (value >= 70) {
                            data.cell.styles.textColor = [38, 162, 105];
                            data.cell.styles.fontStyle = 'bold';
                        } else if (value >= 40) {
                            data.cell.styles.textColor = [229, 165, 10];
                        } else {
                            data.cell.styles.textColor = [224, 27, 36];
                        }
                    }
                }
            });
        }

        // Funções de geração de PDF principal
        function generatePDF(download = true) {
            document.getElementById('loadingPdf').style.display = 'flex';
            
            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 10;
                    let yPos = margin;
                    const today = new Date();
                    
                    // PAGINA 1: CAPA E RESUMO EXECUTIVO
                    
                    doc.setFillColor(26, 95, 180);
                    doc.rect(0, 0, pageWidth, 35, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(22);
                    doc.setFont(undefined, 'bold');
                    doc.text('OPERAÇÃO BARRICADA ZERO', pageWidth/2, 15, { align: 'center' });
                    
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'normal');
                    doc.text('Planejamento Operacional Otimizado', pageWidth/2, 23, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.text(`Gerado em: ${today.toLocaleDateString('pt-BR')} às ${today.toLocaleTimeString('pt-BR').slice(0,5)}`, pageWidth/2, 30, { align: 'center' });
                    
                    yPos = 45;
                    
                    if (allData.planningData) {
                        const { distribuicaoPorDia, localidadesPorCPA, localidadesPorMunicipio, semanas, weekdays, startDate, numWeeks } = allData.planningData;
                        const totalLocalidades = distribuicaoPorDia.flat().length;
                        const localidadesComBPMValido = distribuicaoPorDia.flat().filter(loc => loc.bpmIsValid).length;
                        
                        doc.setFillColor(240, 247, 255);
                        doc.roundedRect(margin, yPos, pageWidth - 2*margin, 45, 3, 3, 'F');
                        
                        doc.setTextColor(26, 95, 180);
                        doc.setFontSize(14);
                        doc.setFont(undefined, 'bold');
                        doc.text('RESUMO EXECUTIVO', margin + 5, yPos + 10);
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        
                        const col1X = margin + 5;
                        const col2X = margin + 90;
                        const col3X = margin + 180;
                        
                        doc.text(`Período: ${formatDate(weekdays[0])} a ${formatDate(weekdays[weekdays.length - 1])}`, col1X, yPos + 20);
                        doc.text(`Total de Semanas: ${semanas}`, col1X, yPos + 27);
                        doc.text(`Dias Úteis: ${weekdays.length}`, col1X, yPos + 34);
                        
                        doc.text(`Total de Localidades: ${totalLocalidades}`, col2X, yPos + 20);
                        doc.text(`Com BPM Validado: ${localidadesComBPMValido} (${Math.round((localidadesComBPMValido/totalLocalidades)*100)}%)`, col2X, yPos + 27);
                        doc.text(`Sem BPM: ${totalLocalidades - localidadesComBPMValido}`, col2X, yPos + 34);
                        
                        doc.text(`CPAs Envolvidas: ${Object.keys(localidadesPorCPA).length}`, col3X, yPos + 20);
                        doc.text(`Municípios: ${Object.keys(localidadesPorMunicipio).length}`, col3X, yPos + 27);
                        
                        yPos = 100;
                        
                        doc.setTextColor(26, 95, 180);
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('DISTRIBUIÇÃO POR CPA', margin, yPos);
                        yPos += 5;
                        
                        const topCPAs = Object.entries(localidadesPorCPA)
                            .sort((a, b) => b[1].length - a[1].length)
                            .slice(0, 15);
                        
                        doc.autoTable({
                            startY: yPos,
                            head: [['CPA', 'Localidades', 'Com BPM', 'Sem BPM', '% Cobertura']],
                            body: topCPAs.map(([cpa, locs]) => {
                                const comBPM = locs.filter(l => l.bpmIsValid).length;
                                const semBPM = locs.length - comBPM;
                                const cobertura = Math.round((comBPM / locs.length) * 100);
                                return [
                                    cpa.length > 35 ? cpa.substring(0, 32) + '...' : cpa,
                                    locs.length,
                                    comBPM,
                                    semBPM,
                                    cobertura + '%'
                                ];
                            }),
                            styles: { 
                                fontSize: 8,
                                cellPadding: 2
                            },
                            headStyles: { 
                                fillColor: [26, 95, 180],
                                textColor: [255, 255, 255],
                                fontStyle: 'bold'
                            },
                            alternateRowStyles: { fillColor: [248, 249, 250] },
                            margin: { left: margin, right: margin }
                        });
                        
                        // PÁGINAS DE PLANEJAMENTO SEMANAL
                        
                        for (let week = 0; week < semanas; week++) {
                            doc.addPage('l', 'a4');
                            
                            const weekStart = week * 5;
                            const weekDates = weekdays.slice(weekStart, weekStart + 5);
                            const semanaNum = week + 1;
                            
                            doc.setFillColor(26, 95, 180);
                            doc.rect(0, 0, pageWidth, 20, 'F');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(14);
                            doc.setFont(undefined, 'bold');
                            doc.text(`SEMANA ${semanaNum} - ${formatDate(weekDates[0])} a ${formatDate(weekDates[weekDates.length - 1])}`, pageWidth/2, 12, { align: 'center' });
                            
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'normal');
                            doc.text(`Página ${doc.internal.getNumberOfPages()} | Operação Barricada Zero`, pageWidth - margin, 15, { align: 'right' });
                            
                            yPos = 25;
                            
                            const diasNomes = ['SEG', 'TER', 'QUA', 'QUI', 'SEX'];
                            const colWidth = (pageWidth - 2*margin) / 5;
                            
                            doc.setFillColor(38, 162, 105);
                            doc.rect(margin, yPos, pageWidth - 2*margin, 12, 'F');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(10);
                            doc.setFont(undefined, 'bold');
                            
                            for (let d = 0; d < 5; d++) {
                                if (weekDates[d]) {
                                    const colX = margin + (d * colWidth);
                                    doc.text(`${diasNomes[d]} - ${formatDateShort(weekDates[d])}`, colX + colWidth/2, yPos + 8, { align: 'center' });
                                }
                            }
                            
                            yPos += 15;
                            
                            const cpasDaSemana = new Set();
                            for (let d = 0; d < 5; d++) {
                                const diaGlobalIndex = week * 5 + d;
                                const localidadesDoDia = distribuicaoPorDia[diaGlobalIndex] || [];
                                localidadesDoDia.forEach(loc => {
                                    cpasDaSemana.add(loc.cpa);
                                });
                            }
                            
                            const maxCPAsPerPage = 8;
                            const cpasParaMostrar = Array.from(cpasDaSemana)
                                .sort((a, b) => localidadesPorCPA[b].length - localidadesPorCPA[a].length)
                                .slice(0, maxCPAsPerPage);
                            
                            const tableData = [];
                            
                            cpasParaMostrar.forEach(cpa => {
                                const cpaNome = cpa.length > 25 ? cpa.substring(0, 22) + '...' : cpa;
                                
                                const row = [cpaNome];
                                
                                for (let d = 0; d < 5; d++) {
                                    if (weekDates[d]) {
                                        const diaGlobalIndex = week * 5 + d;
                                        const localidadesDoDia = distribuicaoPorDia[diaGlobalIndex] || [];
                                        const localidadesCPA = localidadesDoDia.filter(loc => loc.cpa === cpa);
                                        
                                        const locTexts = localidadesCPA.map(loc => `${loc.localidadeNome} - ${loc.bpm}`);
                                        row.push(locTexts.join('\n') || '-');
                                    } else {
                                        row.push('-');
                                    }
                                }
                                
                                tableData.push(row);
                            });
                            
                            doc.autoTable({
                                startY: yPos,
                                head: [['CPA / Localidades', diasNomes[0], diasNomes[1], diasNomes[2], diasNomes[3], diasNomes[4]]],
                                body: tableData,
                                styles: { 
                                    fontSize: 7,
                                    cellPadding: 2,
                                    overflow: 'linebreak',
                                    valign: 'top'
                                },
                                headStyles: { 
                                    fillColor: [26, 95, 180],
                                    textColor: [255, 255, 255],
                                    fontStyle: 'bold',
                                    fontSize: 8
                                },
                                columnStyles: {
                                    0: { cellWidth: 50, fontStyle: 'bold', fillColor: [240, 247, 255] },
                                    1: { cellWidth: 'auto' },
                                    2: { cellWidth: 'auto' },
                                    3: { cellWidth: 'auto' },
                                    4: { cellWidth: 'auto' },
                                    5: { cellWidth: 'auto' }
                                },
                                alternateRowStyles: { fillColor: [248, 249, 250] },
                                margin: { left: margin, right: margin }
                            });
                            
                            const finalY = doc.lastAutoTable.finalY + 5;
                            doc.setFontSize(7);
                            doc.setTextColor(100, 100, 100);
                                                            
                            if (cpasDaSemana.size > maxCPAsPerPage) {
                                doc.text(`+ ${cpasDaSemana.size - maxCPAsPerPage} CPAs adicionais não exibidas`, margin, finalY + 4);
                            }
                        }
                        
                        // PÁGINA FINAL: LISTA COMPLETA DE LOCALIDADES
                        
                        doc.addPage('l', 'a4');
                        
                        doc.setFillColor(26, 95, 180);
                        doc.rect(0, 0, pageWidth, 20, 'F');
                        
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(14);
                        doc.setFont(undefined, 'bold');
                        doc.text('LISTA COMPLETA DE LOCALIDADES', pageWidth/2, 12, { align: 'center' });
                        
                        yPos = 25;
                        
                        const allLocsData = distribuicaoPorDia.flat()
                            .sort((a, b) => b.data.rem - a.data.rem)
                            .slice(0, 50)
                            .map((loc, idx) => [
                                idx + 1,
                                loc.localidadeNome,
                                loc.municipio,
                                loc.cpa,
                                loc.bpmIsValid ? loc.bpm : 'N/I',
                                loc.data.rem,
                                loc.data.peso.toFixed(1),
                                loc.intensityLevel,
                                loc.bpmIsValid ? 'SIM' : 'NÃO'
                            ]);
                        
                        doc.autoTable({
                            startY: yPos,
                            head: [['#', 'Localidade', 'Município', 'CPA', 'BPM', 'Rem', 'Peso', 'Intens.', 'Valid']],
                            body: allLocsData,
                            styles: { 
                                fontSize: 7,
                                cellPadding: 2
                            },
                            headStyles: { 
                                fillColor: [26, 95, 180],
                                textColor: [255, 255, 255],
                                fontStyle: 'bold'
                            },
                            columnStyles: {
                                0: { cellWidth: 8 },
                                1: { cellWidth: 45 },
                                2: { cellWidth: 35 },
                                3: { cellWidth: 35 },
                                4: { cellWidth: 30 },
                                5: { cellWidth: 15, halign: 'center' },
                                6: { cellWidth: 15, halign: 'center' },
                                7: { cellWidth: 20, halign: 'center' },
                                8: { cellWidth: 15, halign: 'center' }
                            },
                            alternateRowStyles: { fillColor: [248, 249, 250] },
                            margin: { left: margin, right: margin },
                            didParseCell: function(data) {
                                if (data.column.index === 7 && data.section === 'body') {
                                    if (data.cell.raw === 'ALTA') {
                                        data.cell.styles.textColor = [224, 27, 36];
                                        data.cell.styles.fontStyle = 'bold';
                                    } else if (data.cell.raw === 'MEDIA') {
                                        data.cell.styles.textColor = [229, 165, 10];
                                    }
                                }
                                if (data.column.index === 8 && data.section === 'body') {
                                    if (data.cell.raw === 'SIM') {
                                        data.cell.styles.textColor = [38, 162, 105];
                                        data.cell.styles.fontStyle = 'bold';
                                    } else {
                                        data.cell.styles.textColor = [229, 165, 10];
                                    }
                                }
                            }
                        });
                        
                        const finalY2 = doc.lastAutoTable.finalY + 5;
                        doc.setFontSize(7);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Exibindo as ${Math.min(50, distribuicaoPorDia.flat().length)} localidades com maior número de remoções.`, margin, finalY2);
                        if (distribuicaoPorDia.flat().length > 50) {
                            doc.text(`Total de ${distribuicaoPorDia.flat().length} localidades no planejamento.`, margin, finalY2 + 4);
                        }
                    }
                    
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.setFontSize(7);
                        doc.setTextColor(150, 150, 150);
                        doc.text(`Página ${i} de ${totalPages}`, pageWidth/2, pageHeight - 5, { align: 'center' });
                    }
                    
                    if (download) {
                        const fileName = `Planejamento_Barricada_Zero_${today.toISOString().slice(0,10)}.pdf`;
                        doc.save(fileName);
                    } else {
                        const pdfBlob = doc.output('blob');
                        const url = URL.createObjectURL(pdfBlob);
                        window.open(url, '_blank');
                    }
                    
                } catch (error) {
                    console.error('Erro ao gerar PDF:', error);
                    alert('Erro ao gerar PDF. Por favor, verifique o console para detalhes.');
                } finally {
                    document.getElementById('loadingPdf').style.display = 'none';
                }
            }, 100);
        }
    </script>
</body>
</html>
